\hypertarget{_edgent___e_s_p8266_2_config_mode_8h_source}{}\doxysection{Config\+Mode.\+h}
\label{_edgent___e_s_p8266_2_config_mode_8h_source}\index{lib/Blynk/examples/Blynk.Edgent/Edgent\_ESP8266/ConfigMode.h@{lib/Blynk/examples/Blynk.Edgent/Edgent\_ESP8266/ConfigMode.h}}

\begin{DoxyCode}{0}
\DoxyCodeLine{1 }
\DoxyCodeLine{2 \textcolor{preprocessor}{\#include <ESP8266WiFi.h>}}
\DoxyCodeLine{3 \textcolor{preprocessor}{\#include <ESP8266WebServer.h>}}
\DoxyCodeLine{4 \textcolor{preprocessor}{\#include <ESP8266HTTPUpdateServer.h>}}
\DoxyCodeLine{5 \textcolor{preprocessor}{\#include <DNSServer.h>}}
\DoxyCodeLine{6 }
\DoxyCodeLine{7 ESP8266WebServer server(80);}
\DoxyCodeLine{8 ESP8266HTTPUpdateServer httpUpdater;}
\DoxyCodeLine{9 DNSServer dnsServer;}
\DoxyCodeLine{10 \textcolor{keyword}{const} \textcolor{keywordtype}{byte} DNS\_PORT = 53;}
\DoxyCodeLine{11 }
\DoxyCodeLine{12 }
\DoxyCodeLine{13 \textcolor{preprocessor}{\#ifdef BLYNK\_USE\_SPIFFS}}
\DoxyCodeLine{14 \textcolor{preprocessor}{  \#include <FS.h>}}
\DoxyCodeLine{15 \textcolor{preprocessor}{\#else}}
\DoxyCodeLine{16   \textcolor{keyword}{const} \textcolor{keywordtype}{char}* config\_form = R\textcolor{stringliteral}{"{}html(}}
\DoxyCodeLine{17 \textcolor{stringliteral}{<!DOCTYPE HTML>}}
\DoxyCodeLine{18 \textcolor{stringliteral}{<html>}}
\DoxyCodeLine{19 \textcolor{stringliteral}{<head>}}
\DoxyCodeLine{20 \textcolor{stringliteral}{  <title>WiFi setup</title>}}
\DoxyCodeLine{21 \textcolor{stringliteral}{  <style>}}
\DoxyCodeLine{22 \textcolor{stringliteral}{  body \{}}
\DoxyCodeLine{23 \textcolor{stringliteral}{    background-\/color: \#fcfcfc;}}
\DoxyCodeLine{24 \textcolor{stringliteral}{    box-\/sizing: border-\/box;}}
\DoxyCodeLine{25 \textcolor{stringliteral}{  \}}}
\DoxyCodeLine{26 \textcolor{stringliteral}{  body, input \{}}
\DoxyCodeLine{27 \textcolor{stringliteral}{    font-\/family: Roboto, sans-\/serif;}}
\DoxyCodeLine{28 \textcolor{stringliteral}{    font-\/weight: 400;}}
\DoxyCodeLine{29 \textcolor{stringliteral}{    font-\/size: 16px;}}
\DoxyCodeLine{30 \textcolor{stringliteral}{  \}}}
\DoxyCodeLine{31 \textcolor{stringliteral}{  .centered \{}}
\DoxyCodeLine{32 \textcolor{stringliteral}{    position: fixed;}}
\DoxyCodeLine{33 \textcolor{stringliteral}{    top: 50\%;}}
\DoxyCodeLine{34 \textcolor{stringliteral}{    left: 50\%;}}
\DoxyCodeLine{35 \textcolor{stringliteral}{    transform: translate(-\/50\%, -\/50\%);}}
\DoxyCodeLine{36 \textcolor{stringliteral}{}}
\DoxyCodeLine{37 \textcolor{stringliteral}{    padding: 20px;}}
\DoxyCodeLine{38 \textcolor{stringliteral}{    background-\/color: \#ccc;}}
\DoxyCodeLine{39 \textcolor{stringliteral}{    border-\/radius: 4px;}}
\DoxyCodeLine{40 \textcolor{stringliteral}{  \}}}
\DoxyCodeLine{41 \textcolor{stringliteral}{  td \{ padding:0 0 0 5px; \}}}
\DoxyCodeLine{42 \textcolor{stringliteral}{  label \{ white-\/space:nowrap; \}}}
\DoxyCodeLine{43 \textcolor{stringliteral}{  input \{ width: 20em; \}}}
\DoxyCodeLine{44 \textcolor{stringliteral}{  input[name="{}port"{}] \{ width: 5em; \}}}
\DoxyCodeLine{45 \textcolor{stringliteral}{  input[type="{}submit"{}], img \{ margin: auto; display: block; width: 30\%; \}}}
\DoxyCodeLine{46 \textcolor{stringliteral}{  </style>}}
\DoxyCodeLine{47 \textcolor{stringliteral}{</head> }}
\DoxyCodeLine{48 \textcolor{stringliteral}{<body>}}
\DoxyCodeLine{49 \textcolor{stringliteral}{<div class="{}centered"{}>}}
\DoxyCodeLine{50 \textcolor{stringliteral}{  <form method="{}get"{} action="{}config"{}>}}
\DoxyCodeLine{51 \textcolor{stringliteral}{    <table>}}
\DoxyCodeLine{52 \textcolor{stringliteral}{    <tr><td><label for="{}ssid"{}>WiFi SSID:</label></td>  <td><input type="{}text"{} name="{}ssid"{} length=64 required="{}required"{}></td></tr>}}
\DoxyCodeLine{53 \textcolor{stringliteral}{    <tr><td><label for="{}pass"{}>Password:</label></td>   <td><input type="{}text"{} name="{}pass"{} length=64></td></tr>}}
\DoxyCodeLine{54 \textcolor{stringliteral}{    <tr><td><label for="{}blynk"{}>Auth token:</label></td><td><input type="{}text"{} name="{}blynk"{} placeholder="{}a0b1c2d..."{} pattern="{}[-\/\_a-\/zA-\/Z0-\/9]\{32\}"{} maxlength="{}32"{} required="{}required"{}></td></tr>}}
\DoxyCodeLine{55 \textcolor{stringliteral}{    <tr><td><label for="{}host"{}>Host:</label></td>       <td><input type="{}text"{} name="{}host"{} value="{}blynk.cloud"{} length=64></td></tr>}}
\DoxyCodeLine{56 \textcolor{stringliteral}{    <tr><td><label for="{}port\_ssl"{}>Port:</label></td>   <td><input type="{}number"{} name="{}port\_ssl"{} value="{}443"{} min="{}1"{} max="{}65535"{}></td></tr>}}
\DoxyCodeLine{57 \textcolor{stringliteral}{    </table><br/>}}
\DoxyCodeLine{58 \textcolor{stringliteral}{    <input type="{}submit"{} value="{}Apply"{}>}}
\DoxyCodeLine{59 \textcolor{stringliteral}{  </form>}}
\DoxyCodeLine{60 \textcolor{stringliteral}{</div>}}
\DoxyCodeLine{61 \textcolor{stringliteral}{</body>}}
\DoxyCodeLine{62 \textcolor{stringliteral}{</html>}}
\DoxyCodeLine{63 \textcolor{stringliteral}{)html"{};}}
\DoxyCodeLine{64 \textcolor{stringliteral}{}\textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{65 }
\DoxyCodeLine{66 \textcolor{keywordtype}{void} restartMCU() \{}
\DoxyCodeLine{67   ESP.restart();}
\DoxyCodeLine{68   delay(10000);}
\DoxyCodeLine{69   ESP.reset();}
\DoxyCodeLine{70   \textcolor{keywordflow}{while}(1) \{\};}
\DoxyCodeLine{71 \}}
\DoxyCodeLine{72 }
\DoxyCodeLine{73 }
\DoxyCodeLine{74 \textcolor{keywordtype}{void} getWiFiName(\textcolor{keywordtype}{char}* buff, \textcolor{keywordtype}{size\_t} len, \textcolor{keywordtype}{bool} withPrefix = \textcolor{keyword}{true}) \{}
\DoxyCodeLine{75   \textcolor{keywordtype}{byte} mac[6] = \{ 0, \};}
\DoxyCodeLine{76   WiFi.macAddress(mac);}
\DoxyCodeLine{77 }
\DoxyCodeLine{78   uint32\_t unique = 0;}
\DoxyCodeLine{79   \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} i=0; i<4; i++) \{}
\DoxyCodeLine{80     unique = BlynkCRC32(\&mac, \textcolor{keyword}{sizeof}(mac), unique);}
\DoxyCodeLine{81   \}}
\DoxyCodeLine{82   unique \&= 0xFFFFF;}
\DoxyCodeLine{83 }
\DoxyCodeLine{84   \textcolor{keywordflow}{if} (withPrefix) \{}
\DoxyCodeLine{85     snprintf(buff, len, \textcolor{stringliteral}{"{}Blynk \%s-\/\%05X"{}}, BLYNK\_DEVICE\_NAME, unique);}
\DoxyCodeLine{86   \} \textcolor{keywordflow}{else} \{}
\DoxyCodeLine{87     snprintf(buff, len, \textcolor{stringliteral}{"{}\%s-\/\%05X"{}}, BLYNK\_DEVICE\_NAME, unique);}
\DoxyCodeLine{88   \}}
\DoxyCodeLine{89 \}}
\DoxyCodeLine{90 }
\DoxyCodeLine{91 \textcolor{keywordtype}{void} enterConfigMode()}
\DoxyCodeLine{92 \{}
\DoxyCodeLine{93   \textcolor{keywordtype}{char} ssidBuff[64];}
\DoxyCodeLine{94   getWiFiName(ssidBuff, \textcolor{keyword}{sizeof}(ssidBuff));}
\DoxyCodeLine{95 }
\DoxyCodeLine{96   WiFi.mode(WIFI\_OFF);}
\DoxyCodeLine{97   delay(100);}
\DoxyCodeLine{98   WiFi.mode(WIFI\_AP\_STA);}
\DoxyCodeLine{99   WiFi.softAPConfig(WIFI\_AP\_IP, WIFI\_AP\_IP, WIFI\_AP\_Subnet);}
\DoxyCodeLine{100   WiFi.softAP(ssidBuff);}
\DoxyCodeLine{101   delay(500);}
\DoxyCodeLine{102 }
\DoxyCodeLine{103   IPAddress myIP = WiFi.softAPIP();}
\DoxyCodeLine{104   \mbox{\hyperlink{_d_h_t_8h_a88edd2aa4feabff4af21a997d5d8aa23}{DEBUG\_PRINT}}(String(\textcolor{stringliteral}{"{}AP SSID: "{}}) + ssidBuff);}
\DoxyCodeLine{105   \mbox{\hyperlink{_d_h_t_8h_a88edd2aa4feabff4af21a997d5d8aa23}{DEBUG\_PRINT}}(String(\textcolor{stringliteral}{"{}AP IP:   "{}}) + myIP[0] + \textcolor{stringliteral}{"{}."{}} + myIP[1] + \textcolor{stringliteral}{"{}."{}} + myIP[2] + \textcolor{stringliteral}{"{}."{}} + myIP[3]);}
\DoxyCodeLine{106 }
\DoxyCodeLine{107   \textcolor{keywordflow}{if} (myIP == (uint32\_t)0)}
\DoxyCodeLine{108   \{}
\DoxyCodeLine{109     config\_set\_last\_error(BLYNK\_PROV\_ERR\_INTERNAL);}
\DoxyCodeLine{110     BlynkState::set(MODE\_ERROR);}
\DoxyCodeLine{111     \textcolor{keywordflow}{return};}
\DoxyCodeLine{112   \}}
\DoxyCodeLine{113 }
\DoxyCodeLine{114   \textcolor{comment}{// Set up DNS Server}}
\DoxyCodeLine{115   dnsServer.setTTL(300); \textcolor{comment}{// Time-\/to-\/live 300s}}
\DoxyCodeLine{116   dnsServer.setErrorReplyCode(DNSReplyCode::ServerFailure); \textcolor{comment}{// Return code for non-\/accessible domains}}
\DoxyCodeLine{117 \textcolor{preprocessor}{\#ifdef WIFI\_CAPTIVE\_PORTAL\_ENABLE}}
\DoxyCodeLine{118   dnsServer.start(DNS\_PORT, \textcolor{stringliteral}{"{}*"{}}, WiFi.softAPIP()); \textcolor{comment}{// Point all to our IP}}
\DoxyCodeLine{119   server.onNotFound(handleRoot);}
\DoxyCodeLine{120 \textcolor{preprocessor}{\#else}}
\DoxyCodeLine{121   dnsServer.start(DNS\_PORT, CONFIG\_AP\_URL, WiFi.softAPIP());}
\DoxyCodeLine{122   \mbox{\hyperlink{_d_h_t_8h_a88edd2aa4feabff4af21a997d5d8aa23}{DEBUG\_PRINT}}(String(\textcolor{stringliteral}{"{}AP URL:  "{}}) + CONFIG\_AP\_URL);}
\DoxyCodeLine{123 \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{124 }
\DoxyCodeLine{125   httpUpdater.setup(\&server, \textcolor{stringliteral}{"{}/update"{}});}
\DoxyCodeLine{126 }
\DoxyCodeLine{127 \textcolor{preprocessor}{\#ifndef BLYNK\_USE\_SPIFFS}}
\DoxyCodeLine{128   server.on(\textcolor{stringliteral}{"{}/"{}}, []() \{}
\DoxyCodeLine{129     server.send(200, \textcolor{stringliteral}{"{}text/html"{}}, config\_form);}
\DoxyCodeLine{130   \});}
\DoxyCodeLine{131 \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{132   server.on(\textcolor{stringliteral}{"{}/config"{}}, []() \{}
\DoxyCodeLine{133     \mbox{\hyperlink{_d_h_t_8h_a88edd2aa4feabff4af21a997d5d8aa23}{DEBUG\_PRINT}}(\textcolor{stringliteral}{"{}Applying configuration..."{}});}
\DoxyCodeLine{134     String ssid = server.arg(\textcolor{stringliteral}{"{}ssid"{}});}
\DoxyCodeLine{135     String ssidManual = server.arg(\textcolor{stringliteral}{"{}ssidManual"{}});}
\DoxyCodeLine{136     String pass = server.arg(\textcolor{stringliteral}{"{}pass"{}});}
\DoxyCodeLine{137     \textcolor{keywordflow}{if} (ssidManual != \textcolor{stringliteral}{"{}"{}}) \{}
\DoxyCodeLine{138       ssid = ssidManual;}
\DoxyCodeLine{139     \}}
\DoxyCodeLine{140     String token = server.arg(\textcolor{stringliteral}{"{}blynk"{}});}
\DoxyCodeLine{141     String host  = server.arg(\textcolor{stringliteral}{"{}host"{}});}
\DoxyCodeLine{142     String port  = server.arg(\textcolor{stringliteral}{"{}port\_ssl"{}});}
\DoxyCodeLine{143 }
\DoxyCodeLine{144     String ip   = server.arg(\textcolor{stringliteral}{"{}ip"{}});}
\DoxyCodeLine{145     String mask = server.arg(\textcolor{stringliteral}{"{}mask"{}});}
\DoxyCodeLine{146     String gw   = server.arg(\textcolor{stringliteral}{"{}gw"{}});}
\DoxyCodeLine{147     String dns  = server.arg(\textcolor{stringliteral}{"{}dns"{}});}
\DoxyCodeLine{148     String dns2 = server.arg(\textcolor{stringliteral}{"{}dns2"{}});}
\DoxyCodeLine{149 }
\DoxyCodeLine{150     \textcolor{keywordtype}{bool} save  = server.arg(\textcolor{stringliteral}{"{}save"{}}).toInt();}
\DoxyCodeLine{151 }
\DoxyCodeLine{152     String content;}
\DoxyCodeLine{153 }
\DoxyCodeLine{154     \mbox{\hyperlink{_d_h_t_8h_a88edd2aa4feabff4af21a997d5d8aa23}{DEBUG\_PRINT}}(String(\textcolor{stringliteral}{"{}WiFi SSID: "{}}) + ssid + \textcolor{stringliteral}{"{} Pass: "{}} + pass);}
\DoxyCodeLine{155     \mbox{\hyperlink{_d_h_t_8h_a88edd2aa4feabff4af21a997d5d8aa23}{DEBUG\_PRINT}}(String(\textcolor{stringliteral}{"{}Blynk cloud: "{}}) + token + \textcolor{stringliteral}{"{} @ "{}} + host + \textcolor{stringliteral}{"{}:"{}} + port);}
\DoxyCodeLine{156 }
\DoxyCodeLine{157     \textcolor{keywordflow}{if} (token.length() == 32 \&\& ssid.length() > 0) \{}
\DoxyCodeLine{158       configStore.setFlag(CONFIG\_FLAG\_VALID, \textcolor{keyword}{false});}
\DoxyCodeLine{159       CopyString(ssid, configStore.wifiSSID);}
\DoxyCodeLine{160       CopyString(pass, configStore.wifiPass);}
\DoxyCodeLine{161       CopyString(token, configStore.cloudToken);}
\DoxyCodeLine{162       \textcolor{keywordflow}{if} (host.length()) \{}
\DoxyCodeLine{163         CopyString(host,  configStore.cloudHost);}
\DoxyCodeLine{164       \}}
\DoxyCodeLine{165       \textcolor{keywordflow}{if} (port.length()) \{}
\DoxyCodeLine{166         configStore.cloudPort = port.toInt();}
\DoxyCodeLine{167       \}}
\DoxyCodeLine{168 }
\DoxyCodeLine{169       IPAddress addr;}
\DoxyCodeLine{170       }
\DoxyCodeLine{171       \textcolor{keywordflow}{if} (ip.length() \&\& addr.fromString(ip)) \{}
\DoxyCodeLine{172         configStore.staticIP = addr;}
\DoxyCodeLine{173         configStore.setFlag(CONFIG\_FLAG\_STATIC\_IP, \textcolor{keyword}{true});}
\DoxyCodeLine{174       \} \textcolor{keywordflow}{else} \{}
\DoxyCodeLine{175         configStore.setFlag(CONFIG\_FLAG\_STATIC\_IP, \textcolor{keyword}{false});}
\DoxyCodeLine{176       \}}
\DoxyCodeLine{177       \textcolor{keywordflow}{if} (mask.length() \&\& addr.fromString(mask)) \{}
\DoxyCodeLine{178         configStore.staticMask = addr;}
\DoxyCodeLine{179       \}}
\DoxyCodeLine{180       \textcolor{keywordflow}{if} (gw.length() \&\& addr.fromString(gw)) \{}
\DoxyCodeLine{181         configStore.staticGW = addr;}
\DoxyCodeLine{182       \}}
\DoxyCodeLine{183       \textcolor{keywordflow}{if} (dns.length() \&\& addr.fromString(dns)) \{}
\DoxyCodeLine{184         configStore.staticDNS = addr;}
\DoxyCodeLine{185       \}}
\DoxyCodeLine{186       \textcolor{keywordflow}{if} (dns2.length() \&\& addr.fromString(dns2)) \{}
\DoxyCodeLine{187         configStore.staticDNS2 = addr;}
\DoxyCodeLine{188       \}}
\DoxyCodeLine{189 }
\DoxyCodeLine{190       \textcolor{keywordflow}{if} (save) \{}
\DoxyCodeLine{191         configStore.setFlag(CONFIG\_FLAG\_VALID, \textcolor{keyword}{true});}
\DoxyCodeLine{192         config\_save();}
\DoxyCodeLine{193 }
\DoxyCodeLine{194         content = R\textcolor{stringliteral}{"{}json(\{"{}status"{}:"{}ok"{},"{}msg"{}:"{}Configuration saved"{}\})json"{};}}
\DoxyCodeLine{195 \textcolor{stringliteral}{      \} }\textcolor{keywordflow}{else} \{}
\DoxyCodeLine{196         content = R\textcolor{stringliteral}{"{}json(\{"{}status"{}:"{}ok"{},"{}msg"{}:"{}Trying to connect..."{}\})json"{};}}
\DoxyCodeLine{197 \textcolor{stringliteral}{      \}}}
\DoxyCodeLine{198 \textcolor{stringliteral}{      server.send(200, }\textcolor{stringliteral}{"{}application/json"{}}, content);}
\DoxyCodeLine{199 }
\DoxyCodeLine{200       BlynkState::set(MODE\_SWITCH\_TO\_STA);}
\DoxyCodeLine{201     \} \textcolor{keywordflow}{else} \{}
\DoxyCodeLine{202       \mbox{\hyperlink{_d_h_t_8h_a88edd2aa4feabff4af21a997d5d8aa23}{DEBUG\_PRINT}}(\textcolor{stringliteral}{"{}Configuration invalid"{}});}
\DoxyCodeLine{203       content = R\textcolor{stringliteral}{"{}json(\{"{}status"{}:"{}error"{},"{}msg"{}:"{}Configuration invalid"{}\})json"{};}}
\DoxyCodeLine{204 \textcolor{stringliteral}{      server.send(500, }\textcolor{stringliteral}{"{}application/json"{}}, content);}
\DoxyCodeLine{205     \}}
\DoxyCodeLine{206   \});}
\DoxyCodeLine{207   server.on(\textcolor{stringliteral}{"{}/board\_info.json"{}}, []() \{}
\DoxyCodeLine{208     \mbox{\hyperlink{_d_h_t_8h_a88edd2aa4feabff4af21a997d5d8aa23}{DEBUG\_PRINT}}(\textcolor{stringliteral}{"{}Sending board info..."{}});}
\DoxyCodeLine{209     \textcolor{keyword}{const} \textcolor{keywordtype}{char}* tmpl = BLYNK\_TEMPLATE\_ID;}
\DoxyCodeLine{210     \textcolor{keywordtype}{char} ssidBuff[64];}
\DoxyCodeLine{211     getWiFiName(ssidBuff, \textcolor{keyword}{sizeof}(ssidBuff));}
\DoxyCodeLine{212     \textcolor{keywordtype}{char} buff[512];}
\DoxyCodeLine{213     snprintf(buff, \textcolor{keyword}{sizeof}(buff),}
\DoxyCodeLine{214       R\textcolor{stringliteral}{"{}json(\{"{}board"{}:"{}\%s"{},"{}tmpl\_id"{}:"{}\%s"{},"{}fw\_type"{}:"{}\%s"{},"{}fw\_ver"{}:"{}\%s"{},"{}ssid"{}:"{}\%s"{},"{}bssid"{}:"{}\%s"{},"{}last\_error"{}:\%d,"{}wifi\_scan"{}:true,"{}static\_ip"{}:true\})json"{},}}
\DoxyCodeLine{215 \textcolor{stringliteral}{      BLYNK\_DEVICE\_NAME,}}
\DoxyCodeLine{216 \textcolor{stringliteral}{      tmpl ? tmpl : }\textcolor{stringliteral}{"{}Unknown"{}},}
\DoxyCodeLine{217       BLYNK\_FIRMWARE\_TYPE,}
\DoxyCodeLine{218       BLYNK\_FIRMWARE\_VERSION,}
\DoxyCodeLine{219       ssidBuff,}
\DoxyCodeLine{220       WiFi.softAPmacAddress().c\_str(),}
\DoxyCodeLine{221       configStore.last\_error}
\DoxyCodeLine{222     );}
\DoxyCodeLine{223     server.send(200, \textcolor{stringliteral}{"{}application/json"{}}, buff);}
\DoxyCodeLine{224   \});}
\DoxyCodeLine{225   server.on(\textcolor{stringliteral}{"{}/wifi\_scan.json"{}}, []() \{}
\DoxyCodeLine{226     \mbox{\hyperlink{_d_h_t_8h_a88edd2aa4feabff4af21a997d5d8aa23}{DEBUG\_PRINT}}(\textcolor{stringliteral}{"{}Scanning networks..."{}});}
\DoxyCodeLine{227     \textcolor{keywordtype}{int} wifi\_nets = WiFi.scanNetworks(\textcolor{keyword}{true}, \textcolor{keyword}{true});}
\DoxyCodeLine{228     \textcolor{keyword}{const} uint32\_t t = millis();}
\DoxyCodeLine{229     \textcolor{keywordflow}{while} (wifi\_nets < 0 \&\&}
\DoxyCodeLine{230            millis() -\/ t < 20000)}
\DoxyCodeLine{231     \{}
\DoxyCodeLine{232       delay(20);}
\DoxyCodeLine{233       wifi\_nets = WiFi.scanComplete();}
\DoxyCodeLine{234     \}}
\DoxyCodeLine{235     \mbox{\hyperlink{_d_h_t_8h_a88edd2aa4feabff4af21a997d5d8aa23}{DEBUG\_PRINT}}(String(\textcolor{stringliteral}{"{}Found networks: "{}}) + wifi\_nets);}
\DoxyCodeLine{236 }
\DoxyCodeLine{237     \textcolor{keywordflow}{if} (wifi\_nets > 0) \{}
\DoxyCodeLine{238       \textcolor{comment}{// Sort networks}}
\DoxyCodeLine{239       \textcolor{keywordtype}{int} indices[wifi\_nets];}
\DoxyCodeLine{240       \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} i = 0; i < wifi\_nets; i++) \{}
\DoxyCodeLine{241         indices[i] = i;}
\DoxyCodeLine{242       \}}
\DoxyCodeLine{243       \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} i = 0; i < wifi\_nets; i++) \{}
\DoxyCodeLine{244         \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} j = i + 1; j < wifi\_nets; j++) \{}
\DoxyCodeLine{245           \textcolor{keywordflow}{if} (WiFi.RSSI(indices[j]) > WiFi.RSSI(indices[i])) \{}
\DoxyCodeLine{246             std::swap(indices[i], indices[j]);}
\DoxyCodeLine{247           \}}
\DoxyCodeLine{248         \}}
\DoxyCodeLine{249       \}}
\DoxyCodeLine{250 }
\DoxyCodeLine{251       wifi\_nets = BlynkMin(15, wifi\_nets); \textcolor{comment}{// Show top 15 networks}}
\DoxyCodeLine{252 }
\DoxyCodeLine{253       \textcolor{comment}{// TODO: skip empty names}}
\DoxyCodeLine{254       server.setContentLength(CONTENT\_LENGTH\_UNKNOWN);}
\DoxyCodeLine{255       server.send(200, \textcolor{stringliteral}{"{}application/json"{}}, \textcolor{stringliteral}{"{}[\(\backslash\)n"{}});}
\DoxyCodeLine{256 }
\DoxyCodeLine{257 }
\DoxyCodeLine{258       \textcolor{keywordtype}{char} buff[256];}
\DoxyCodeLine{259       \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} i = 0; i < wifi\_nets; i++)\{}
\DoxyCodeLine{260         \textcolor{keywordtype}{int} \textcolor{keywordtype}{id} = indices[i];}
\DoxyCodeLine{261 }
\DoxyCodeLine{262         \textcolor{keyword}{const} \textcolor{keywordtype}{char}* sec;}
\DoxyCodeLine{263         \textcolor{keywordflow}{switch} (WiFi.encryptionType(\textcolor{keywordtype}{id})) \{}
\DoxyCodeLine{264         \textcolor{keywordflow}{case} ENC\_TYPE\_WEP:  sec = \textcolor{stringliteral}{"{}WEP"{}}; \textcolor{keywordflow}{break};}
\DoxyCodeLine{265         \textcolor{keywordflow}{case} ENC\_TYPE\_TKIP: sec = \textcolor{stringliteral}{"{}WPA/PSK"{}}; \textcolor{keywordflow}{break};}
\DoxyCodeLine{266         \textcolor{keywordflow}{case} ENC\_TYPE\_CCMP: sec = \textcolor{stringliteral}{"{}WPA2/PSK"{}}; \textcolor{keywordflow}{break};}
\DoxyCodeLine{267         \textcolor{keywordflow}{case} ENC\_TYPE\_AUTO: sec = \textcolor{stringliteral}{"{}WPA/WPA2/PSK"{}}; \textcolor{keywordflow}{break};}
\DoxyCodeLine{268         \textcolor{keywordflow}{case} ENC\_TYPE\_NONE: sec = \textcolor{stringliteral}{"{}OPEN"{}}; \textcolor{keywordflow}{break};}
\DoxyCodeLine{269         \textcolor{keywordflow}{default}:            sec = \textcolor{stringliteral}{"{}unknown"{}}; \textcolor{keywordflow}{break};}
\DoxyCodeLine{270         \}}
\DoxyCodeLine{271 }
\DoxyCodeLine{272         snprintf(buff, \textcolor{keyword}{sizeof}(buff),}
\DoxyCodeLine{273           R\textcolor{stringliteral}{"{}json(  \{"{}ssid"{}:"{}\%s"{},"{}bssid"{}:"{}\%s"{},"{}rssi"{}:\%i,"{}sec"{}:"{}\%s"{},"{}ch"{}:\%i,"{}hidden"{}:\%d\})json"{},}}
\DoxyCodeLine{274 \textcolor{stringliteral}{          WiFi.SSID(}\textcolor{keywordtype}{id}).c\_str(),}
\DoxyCodeLine{275           WiFi.BSSIDstr(\textcolor{keywordtype}{id}).c\_str(),}
\DoxyCodeLine{276           WiFi.RSSI(\textcolor{keywordtype}{id}),}
\DoxyCodeLine{277           sec,}
\DoxyCodeLine{278           WiFi.channel(\textcolor{keywordtype}{id}),}
\DoxyCodeLine{279           WiFi.isHidden(\textcolor{keywordtype}{id})}
\DoxyCodeLine{280         );}
\DoxyCodeLine{281 }
\DoxyCodeLine{282         server.sendContent(buff);}
\DoxyCodeLine{283         \textcolor{keywordflow}{if} (i != wifi\_nets-\/1) server.sendContent(\textcolor{stringliteral}{"{},\(\backslash\)n"{}});}
\DoxyCodeLine{284       \}}
\DoxyCodeLine{285       server.sendContent(\textcolor{stringliteral}{"{}\(\backslash\)n]"{}});}
\DoxyCodeLine{286     \} \textcolor{keywordflow}{else} \{}
\DoxyCodeLine{287       server.send(200, \textcolor{stringliteral}{"{}application/json"{}}, \textcolor{stringliteral}{"{}[]"{}});}
\DoxyCodeLine{288     \}}
\DoxyCodeLine{289   \});}
\DoxyCodeLine{290   server.on(\textcolor{stringliteral}{"{}/reset"{}}, []() \{}
\DoxyCodeLine{291     BlynkState::set(MODE\_RESET\_CONFIG);}
\DoxyCodeLine{292     server.send(200, \textcolor{stringliteral}{"{}application/json"{}}, R\textcolor{stringliteral}{"{}json(\{"{}status"{}:"{}ok"{},"{}msg"{}:"{}Configuration reset"{}\})json"{});}}
\DoxyCodeLine{293 \textcolor{stringliteral}{  \});}}
\DoxyCodeLine{294 \textcolor{stringliteral}{  server.on(}\textcolor{stringliteral}{"{}/reboot"{}}, []() \{}
\DoxyCodeLine{295     restartMCU();}
\DoxyCodeLine{296   \});}
\DoxyCodeLine{297 }
\DoxyCodeLine{298 \textcolor{preprocessor}{\#ifdef BLYNK\_USE\_SPIFFS}}
\DoxyCodeLine{299   \textcolor{keywordflow}{if} (SPIFFS.begin()) \{}
\DoxyCodeLine{300     server.serveStatic(\textcolor{stringliteral}{"{}/img"{}}, SPIFFS, \textcolor{stringliteral}{"{}/img"{}});}
\DoxyCodeLine{301     server.serveStatic(\textcolor{stringliteral}{"{}/"{}}, SPIFFS, \textcolor{stringliteral}{"{}/index.html"{}});}
\DoxyCodeLine{302   \} \textcolor{keywordflow}{else} \{}
\DoxyCodeLine{303     \mbox{\hyperlink{_d_h_t_8h_a88edd2aa4feabff4af21a997d5d8aa23}{DEBUG\_PRINT}}(\textcolor{stringliteral}{"{}Webpage: No SPIFFS"{}});}
\DoxyCodeLine{304   \}}
\DoxyCodeLine{305 \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{306 }
\DoxyCodeLine{307   server.begin();}
\DoxyCodeLine{308 }
\DoxyCodeLine{309   \textcolor{keywordflow}{while} (BlynkState::is(MODE\_WAIT\_CONFIG) || BlynkState::is(MODE\_CONFIGURING)) \{}
\DoxyCodeLine{310     delay(10);}
\DoxyCodeLine{311     dnsServer.processNextRequest();}
\DoxyCodeLine{312     server.handleClient();}
\DoxyCodeLine{313     app\_loop();}
\DoxyCodeLine{314     \textcolor{keywordflow}{if} (BlynkState::is(MODE\_WAIT\_CONFIG) \&\& WiFi.softAPgetStationNum() > 0) \{}
\DoxyCodeLine{315       BlynkState::set(MODE\_CONFIGURING);}
\DoxyCodeLine{316     \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (BlynkState::is(MODE\_CONFIGURING) \&\& WiFi.softAPgetStationNum() == 0) \{}
\DoxyCodeLine{317       BlynkState::set(MODE\_WAIT\_CONFIG);}
\DoxyCodeLine{318     \}}
\DoxyCodeLine{319   \}}
\DoxyCodeLine{320 }
\DoxyCodeLine{321   server.stop();}
\DoxyCodeLine{322   }
\DoxyCodeLine{323 \textcolor{preprocessor}{\#ifdef BLYNK\_USE\_SPIFFS}}
\DoxyCodeLine{324   SPIFFS.end();}
\DoxyCodeLine{325 \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{326 \}}
\DoxyCodeLine{327 }
\DoxyCodeLine{328 \textcolor{keywordtype}{void} enterConnectNet() \{}
\DoxyCodeLine{329   BlynkState::set(MODE\_CONNECTING\_NET);}
\DoxyCodeLine{330   \mbox{\hyperlink{_d_h_t_8h_a88edd2aa4feabff4af21a997d5d8aa23}{DEBUG\_PRINT}}(String(\textcolor{stringliteral}{"{}Connecting to WiFi: "{}}) + configStore.wifiSSID);}
\DoxyCodeLine{331 }
\DoxyCodeLine{332   WiFi.mode(WIFI\_STA);}
\DoxyCodeLine{333 }
\DoxyCodeLine{334   \textcolor{keywordtype}{char} ssidBuff[64];}
\DoxyCodeLine{335   getWiFiName(ssidBuff, \textcolor{keyword}{sizeof}(ssidBuff));}
\DoxyCodeLine{336   String hostname(ssidBuff);}
\DoxyCodeLine{337   hostname.replace(\textcolor{stringliteral}{"{} "{}}, \textcolor{stringliteral}{"{}-\/"{}});}
\DoxyCodeLine{338 }
\DoxyCodeLine{339   WiFi.hostname(hostname.c\_str());}
\DoxyCodeLine{340 }
\DoxyCodeLine{341   \textcolor{keywordflow}{if} (configStore.getFlag(CONFIG\_FLAG\_STATIC\_IP)) \{}
\DoxyCodeLine{342     \textcolor{keywordflow}{if} (!WiFi.config(configStore.staticIP,}
\DoxyCodeLine{343                     configStore.staticGW,}
\DoxyCodeLine{344                     configStore.staticMask,}
\DoxyCodeLine{345                     configStore.staticDNS,}
\DoxyCodeLine{346                     configStore.staticDNS2)}
\DoxyCodeLine{347     ) \{}
\DoxyCodeLine{348       \mbox{\hyperlink{_d_h_t_8h_a88edd2aa4feabff4af21a997d5d8aa23}{DEBUG\_PRINT}}(\textcolor{stringliteral}{"{}Failed to configure Static IP"{}});}
\DoxyCodeLine{349       config\_set\_last\_error(BLYNK\_PROV\_ERR\_CONFIG);}
\DoxyCodeLine{350       BlynkState::set(MODE\_ERROR);}
\DoxyCodeLine{351       \textcolor{keywordflow}{return};}
\DoxyCodeLine{352     \}}
\DoxyCodeLine{353   \}}
\DoxyCodeLine{354 }
\DoxyCodeLine{355   \textcolor{keywordflow}{if} (!WiFi.begin(configStore.wifiSSID, configStore.wifiPass)) \{}
\DoxyCodeLine{356     config\_set\_last\_error(BLYNK\_PROV\_ERR\_CONFIG);}
\DoxyCodeLine{357     BlynkState::set(MODE\_ERROR);}
\DoxyCodeLine{358     \textcolor{keywordflow}{return};}
\DoxyCodeLine{359   \}}
\DoxyCodeLine{360 }
\DoxyCodeLine{361   \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{long} timeoutMs = millis() + WIFI\_NET\_CONNECT\_TIMEOUT;}
\DoxyCodeLine{362   \textcolor{keywordflow}{while} ((timeoutMs > millis()) \&\& (WiFi.status() != WL\_CONNECTED))}
\DoxyCodeLine{363   \{}
\DoxyCodeLine{364     delay(10);}
\DoxyCodeLine{365     app\_loop();}
\DoxyCodeLine{366 }
\DoxyCodeLine{367     \textcolor{keywordflow}{if} (!BlynkState::is(MODE\_CONNECTING\_NET)) \{}
\DoxyCodeLine{368       WiFi.disconnect();}
\DoxyCodeLine{369       \textcolor{keywordflow}{return};}
\DoxyCodeLine{370     \}}
\DoxyCodeLine{371   \}}
\DoxyCodeLine{372 }
\DoxyCodeLine{373   \textcolor{keywordflow}{if} (WiFi.status() == WL\_CONNECTED) \{}
\DoxyCodeLine{374     IPAddress localip = WiFi.localIP();}
\DoxyCodeLine{375     \textcolor{keywordflow}{if} (configStore.getFlag(CONFIG\_FLAG\_STATIC\_IP)) \{}
\DoxyCodeLine{376       BLYNK\_LOG\_IP(\textcolor{stringliteral}{"{}Using Static IP: "{}}, localip);}
\DoxyCodeLine{377     \} \textcolor{keywordflow}{else} \{}
\DoxyCodeLine{378       BLYNK\_LOG\_IP(\textcolor{stringliteral}{"{}Using Dynamic IP: "{}}, localip);}
\DoxyCodeLine{379     \}}
\DoxyCodeLine{380 }
\DoxyCodeLine{381     BlynkState::set(MODE\_CONNECTING\_CLOUD);}
\DoxyCodeLine{382   \} \textcolor{keywordflow}{else} \{}
\DoxyCodeLine{383     config\_set\_last\_error(BLYNK\_PROV\_ERR\_NETWORK);}
\DoxyCodeLine{384     BlynkState::set(MODE\_ERROR);}
\DoxyCodeLine{385   \}}
\DoxyCodeLine{386 \}}
\DoxyCodeLine{387 }
\DoxyCodeLine{388 \textcolor{keywordtype}{void} enterConnectCloud() \{}
\DoxyCodeLine{389   BlynkState::set(MODE\_CONNECTING\_CLOUD);}
\DoxyCodeLine{390 }
\DoxyCodeLine{391   Blynk.config(configStore.cloudToken, configStore.cloudHost, configStore.cloudPort);}
\DoxyCodeLine{392   Blynk.connect(0);}
\DoxyCodeLine{393 }
\DoxyCodeLine{394   \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{long} timeoutMs = millis() + WIFI\_CLOUD\_CONNECT\_TIMEOUT;}
\DoxyCodeLine{395   \textcolor{keywordflow}{while} ((timeoutMs > millis()) \&\&}
\DoxyCodeLine{396         (!Blynk.isTokenInvalid()) \&\&}
\DoxyCodeLine{397         (Blynk.connected() == \textcolor{keyword}{false}))}
\DoxyCodeLine{398   \{}
\DoxyCodeLine{399     delay(10);}
\DoxyCodeLine{400     Blynk.run();}
\DoxyCodeLine{401     app\_loop();}
\DoxyCodeLine{402     \textcolor{keywordflow}{if} (!BlynkState::is(MODE\_CONNECTING\_CLOUD)) \{}
\DoxyCodeLine{403       Blynk.disconnect();}
\DoxyCodeLine{404       \textcolor{keywordflow}{return};}
\DoxyCodeLine{405     \}}
\DoxyCodeLine{406   \}}
\DoxyCodeLine{407 }
\DoxyCodeLine{408   \textcolor{keywordflow}{if} (millis() > timeoutMs) \{}
\DoxyCodeLine{409     \mbox{\hyperlink{_d_h_t_8h_a88edd2aa4feabff4af21a997d5d8aa23}{DEBUG\_PRINT}}(\textcolor{stringliteral}{"{}Timeout"{}});}
\DoxyCodeLine{410   \}}
\DoxyCodeLine{411 }
\DoxyCodeLine{412   \textcolor{keywordflow}{if} (Blynk.isTokenInvalid()) \{}
\DoxyCodeLine{413     config\_set\_last\_error(BLYNK\_PROV\_ERR\_TOKEN);}
\DoxyCodeLine{414     BlynkState::set(MODE\_WAIT\_CONFIG);}
\DoxyCodeLine{415   \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (Blynk.connected()) \{}
\DoxyCodeLine{416     BlynkState::set(MODE\_RUNNING);}
\DoxyCodeLine{417 }
\DoxyCodeLine{418     \textcolor{keywordflow}{if} (!configStore.getFlag(CONFIG\_FLAG\_VALID)) \{}
\DoxyCodeLine{419       configStore.last\_error = BLYNK\_PROV\_ERR\_NONE;}
\DoxyCodeLine{420       configStore.setFlag(CONFIG\_FLAG\_VALID, \textcolor{keyword}{true});}
\DoxyCodeLine{421       config\_save();}
\DoxyCodeLine{422     \}}
\DoxyCodeLine{423   \} \textcolor{keywordflow}{else} \{}
\DoxyCodeLine{424     config\_set\_last\_error(BLYNK\_PROV\_ERR\_CLOUD);}
\DoxyCodeLine{425     BlynkState::set(MODE\_ERROR);}
\DoxyCodeLine{426   \}}
\DoxyCodeLine{427 \}}
\DoxyCodeLine{428 }
\DoxyCodeLine{429 \textcolor{keywordtype}{void} enterSwitchToSTA() \{}
\DoxyCodeLine{430   BlynkState::set(MODE\_SWITCH\_TO\_STA);}
\DoxyCodeLine{431 }
\DoxyCodeLine{432   \mbox{\hyperlink{_d_h_t_8h_a88edd2aa4feabff4af21a997d5d8aa23}{DEBUG\_PRINT}}(\textcolor{stringliteral}{"{}Switching to STA..."{}});}
\DoxyCodeLine{433 }
\DoxyCodeLine{434   delay(1000);}
\DoxyCodeLine{435   WiFi.mode(WIFI\_OFF);}
\DoxyCodeLine{436   delay(100);}
\DoxyCodeLine{437   WiFi.mode(WIFI\_STA);}
\DoxyCodeLine{438 }
\DoxyCodeLine{439   BlynkState::set(MODE\_CONNECTING\_NET);}
\DoxyCodeLine{440 \}}
\DoxyCodeLine{441 }
\DoxyCodeLine{442 \textcolor{keywordtype}{void} enterError() \{}
\DoxyCodeLine{443   BlynkState::set(MODE\_ERROR);}
\DoxyCodeLine{444   }
\DoxyCodeLine{445   \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{long} timeoutMs = millis() + 10000;}
\DoxyCodeLine{446   \textcolor{keywordflow}{while} (timeoutMs > millis() || g\_buttonPressed)}
\DoxyCodeLine{447   \{}
\DoxyCodeLine{448     delay(10);}
\DoxyCodeLine{449     app\_loop();}
\DoxyCodeLine{450     \textcolor{keywordflow}{if} (!BlynkState::is(MODE\_ERROR)) \{}
\DoxyCodeLine{451       \textcolor{keywordflow}{return};}
\DoxyCodeLine{452     \}}
\DoxyCodeLine{453   \}}
\DoxyCodeLine{454   \mbox{\hyperlink{_d_h_t_8h_a88edd2aa4feabff4af21a997d5d8aa23}{DEBUG\_PRINT}}(\textcolor{stringliteral}{"{}Restarting after error."{}});}
\DoxyCodeLine{455   delay(10);}
\DoxyCodeLine{456 }
\DoxyCodeLine{457   restartMCU();}
\DoxyCodeLine{458 \}}
\DoxyCodeLine{459 }

\end{DoxyCode}
