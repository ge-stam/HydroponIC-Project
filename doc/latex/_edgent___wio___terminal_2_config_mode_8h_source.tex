\hypertarget{_edgent___wio___terminal_2_config_mode_8h_source}{}\doxysection{Config\+Mode.\+h}
\label{_edgent___wio___terminal_2_config_mode_8h_source}\index{lib/Blynk/examples/Blynk.Edgent/Edgent\_Wio\_Terminal/ConfigMode.h@{lib/Blynk/examples/Blynk.Edgent/Edgent\_Wio\_Terminal/ConfigMode.h}}

\begin{DoxyCode}{0}
\DoxyCodeLine{1 }
\DoxyCodeLine{2 \textcolor{preprocessor}{\#include <WiFiClient.h>}}
\DoxyCodeLine{3 \textcolor{preprocessor}{\#include <WebServer.h>}}
\DoxyCodeLine{4 \textcolor{preprocessor}{\#include <DNSServer.h>}}
\DoxyCodeLine{5 }
\DoxyCodeLine{6 WebServer server(80);}
\DoxyCodeLine{7 DNSServer dnsServer;}
\DoxyCodeLine{8 \textcolor{keyword}{const} \textcolor{keywordtype}{byte} DNS\_PORT = 53;}
\DoxyCodeLine{9 }
\DoxyCodeLine{10 \textcolor{preprocessor}{\#ifdef BLYNK\_USE\_SPIFFS}}
\DoxyCodeLine{11 \textcolor{preprocessor}{  \#include "{}SPIFFS.h"{}}}
\DoxyCodeLine{12 \textcolor{preprocessor}{\#else}}
\DoxyCodeLine{13   \textcolor{keyword}{const} \textcolor{keywordtype}{char}* config\_form = R\textcolor{stringliteral}{"{}html(}}
\DoxyCodeLine{14 \textcolor{stringliteral}{<!DOCTYPE HTML>}}
\DoxyCodeLine{15 \textcolor{stringliteral}{<html>}}
\DoxyCodeLine{16 \textcolor{stringliteral}{<head>}}
\DoxyCodeLine{17 \textcolor{stringliteral}{  <title>WiFi setup</title>}}
\DoxyCodeLine{18 \textcolor{stringliteral}{  <style>}}
\DoxyCodeLine{19 \textcolor{stringliteral}{  body \{}}
\DoxyCodeLine{20 \textcolor{stringliteral}{    background-\/color: \#fcfcfc;}}
\DoxyCodeLine{21 \textcolor{stringliteral}{    box-\/sizing: border-\/box;}}
\DoxyCodeLine{22 \textcolor{stringliteral}{  \}}}
\DoxyCodeLine{23 \textcolor{stringliteral}{  body, input \{}}
\DoxyCodeLine{24 \textcolor{stringliteral}{    font-\/family: Roboto, sans-\/serif;}}
\DoxyCodeLine{25 \textcolor{stringliteral}{    font-\/weight: 400;}}
\DoxyCodeLine{26 \textcolor{stringliteral}{    font-\/size: 16px;}}
\DoxyCodeLine{27 \textcolor{stringliteral}{  \}}}
\DoxyCodeLine{28 \textcolor{stringliteral}{  .centered \{}}
\DoxyCodeLine{29 \textcolor{stringliteral}{    position: fixed;}}
\DoxyCodeLine{30 \textcolor{stringliteral}{    top: 50\%;}}
\DoxyCodeLine{31 \textcolor{stringliteral}{    left: 50\%;}}
\DoxyCodeLine{32 \textcolor{stringliteral}{    transform: translate(-\/50\%, -\/50\%);}}
\DoxyCodeLine{33 \textcolor{stringliteral}{}}
\DoxyCodeLine{34 \textcolor{stringliteral}{    padding: 20px;}}
\DoxyCodeLine{35 \textcolor{stringliteral}{    background-\/color: \#ccc;}}
\DoxyCodeLine{36 \textcolor{stringliteral}{    border-\/radius: 4px;}}
\DoxyCodeLine{37 \textcolor{stringliteral}{  \}}}
\DoxyCodeLine{38 \textcolor{stringliteral}{  td \{ padding:0 0 0 5px; \}}}
\DoxyCodeLine{39 \textcolor{stringliteral}{  label \{ white-\/space:nowrap; \}}}
\DoxyCodeLine{40 \textcolor{stringliteral}{  input \{ width: 20em; \}}}
\DoxyCodeLine{41 \textcolor{stringliteral}{  input[name="{}port"{}] \{ width: 5em; \}}}
\DoxyCodeLine{42 \textcolor{stringliteral}{  input[type="{}submit"{}], img \{ margin: auto; display: block; width: 30\%; \}}}
\DoxyCodeLine{43 \textcolor{stringliteral}{  </style>}}
\DoxyCodeLine{44 \textcolor{stringliteral}{</head> }}
\DoxyCodeLine{45 \textcolor{stringliteral}{<body>}}
\DoxyCodeLine{46 \textcolor{stringliteral}{<div class="{}centered"{}>}}
\DoxyCodeLine{47 \textcolor{stringliteral}{  <form method="{}get"{} action="{}config"{}>}}
\DoxyCodeLine{48 \textcolor{stringliteral}{    <table>}}
\DoxyCodeLine{49 \textcolor{stringliteral}{    <tr><td><label for="{}ssid"{}>WiFi SSID:</label></td>  <td><input type="{}text"{} name="{}ssid"{} length=64 required="{}required"{}></td></tr>}}
\DoxyCodeLine{50 \textcolor{stringliteral}{    <tr><td><label for="{}pass"{}>Password:</label></td>   <td><input type="{}text"{} name="{}pass"{} length=64></td></tr>}}
\DoxyCodeLine{51 \textcolor{stringliteral}{    <tr><td><label for="{}blynk"{}>Auth token:</label></td><td><input type="{}text"{} name="{}blynk"{} placeholder="{}a0b1c2d..."{} pattern="{}[-\/\_a-\/zA-\/Z0-\/9]\{32\}"{} maxlength="{}32"{} required="{}required"{}></td></tr>}}
\DoxyCodeLine{52 \textcolor{stringliteral}{    <tr><td><label for="{}host"{}>Host:</label></td>       <td><input type="{}text"{} name="{}host"{} value="{}blynk.cloud"{} length=64></td></tr>}}
\DoxyCodeLine{53 \textcolor{stringliteral}{    <tr><td><label for="{}port\_ssl"{}>Port:</label></td>   <td><input type="{}number"{} name="{}port\_ssl"{} value="{}443"{} min="{}1"{} max="{}65535"{}></td></tr>}}
\DoxyCodeLine{54 \textcolor{stringliteral}{    </table><br/>}}
\DoxyCodeLine{55 \textcolor{stringliteral}{    <input type="{}submit"{} value="{}Apply"{}>}}
\DoxyCodeLine{56 \textcolor{stringliteral}{  </form>}}
\DoxyCodeLine{57 \textcolor{stringliteral}{</div>}}
\DoxyCodeLine{58 \textcolor{stringliteral}{</body>}}
\DoxyCodeLine{59 \textcolor{stringliteral}{</html>}}
\DoxyCodeLine{60 \textcolor{stringliteral}{)html"{};}}
\DoxyCodeLine{61 \textcolor{stringliteral}{}\textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{62 }
\DoxyCodeLine{63 \textcolor{keywordtype}{void} restartMCU() \{}
\DoxyCodeLine{64   NVIC\_SystemReset();}
\DoxyCodeLine{65 \}}
\DoxyCodeLine{66 }
\DoxyCodeLine{67 }
\DoxyCodeLine{68 \textcolor{keywordtype}{void} getWiFiName(\textcolor{keywordtype}{char}* buff, \textcolor{keywordtype}{size\_t} len, \textcolor{keywordtype}{bool} withPrefix = \textcolor{keyword}{true}) \{}
\DoxyCodeLine{69   \textcolor{keyword}{static} \textcolor{keywordtype}{byte} mac[6] = \{ 0, \};}
\DoxyCodeLine{70   \textcolor{keyword}{static} \textcolor{keywordtype}{bool} needMac = \textcolor{keyword}{true};}
\DoxyCodeLine{71   \textcolor{keywordflow}{if} (needMac) \{}
\DoxyCodeLine{72     WiFi.macAddress(mac);}
\DoxyCodeLine{73     needMac = \textcolor{keyword}{false};}
\DoxyCodeLine{74   \}}
\DoxyCodeLine{75 }
\DoxyCodeLine{76   uint32\_t unique = 0;}
\DoxyCodeLine{77   \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} i=0; i<4; i++) \{}
\DoxyCodeLine{78     unique = BlynkCRC32(\&mac, \textcolor{keyword}{sizeof}(mac), unique);}
\DoxyCodeLine{79   \}}
\DoxyCodeLine{80   unique \&= 0xFFFFF;}
\DoxyCodeLine{81 }
\DoxyCodeLine{82   \textcolor{keywordflow}{if} (withPrefix) \{}
\DoxyCodeLine{83     snprintf(buff, len, \textcolor{stringliteral}{"{}Blynk \%s-\/\%05X"{}}, BLYNK\_DEVICE\_NAME, unique);}
\DoxyCodeLine{84   \} \textcolor{keywordflow}{else} \{}
\DoxyCodeLine{85     snprintf(buff, len, \textcolor{stringliteral}{"{}\%s-\/\%05X"{}}, BLYNK\_DEVICE\_NAME, unique);}
\DoxyCodeLine{86   \}}
\DoxyCodeLine{87 \}}
\DoxyCodeLine{88 }
\DoxyCodeLine{89 }
\DoxyCodeLine{90 \textcolor{keywordtype}{void} handleRoot() \{}
\DoxyCodeLine{91   server.send(200, \textcolor{stringliteral}{"{}text/html"{}}, config\_form);}
\DoxyCodeLine{92 \}}
\DoxyCodeLine{93 }
\DoxyCodeLine{94 \textcolor{keywordtype}{void} enterConfigMode()}
\DoxyCodeLine{95 \{}
\DoxyCodeLine{96   \textcolor{keywordtype}{char} ssidBuff[64];}
\DoxyCodeLine{97   getWiFiName(ssidBuff, \textcolor{keyword}{sizeof}(ssidBuff));}
\DoxyCodeLine{98 }
\DoxyCodeLine{99   WiFi.mode(WIFI\_OFF);}
\DoxyCodeLine{100   delay(100);}
\DoxyCodeLine{101   WiFi.mode(WIFI\_AP);}
\DoxyCodeLine{102   delay(2000);}
\DoxyCodeLine{103   WiFi.softAPConfig(WIFI\_AP\_IP, WIFI\_AP\_IP, WIFI\_AP\_Subnet);}
\DoxyCodeLine{104   WiFi.softAP(ssidBuff);}
\DoxyCodeLine{105   delay(500);}
\DoxyCodeLine{106 }
\DoxyCodeLine{107   IPAddress myIP = WiFi.softAPIP();}
\DoxyCodeLine{108   \mbox{\hyperlink{_d_h_t_8h_a88edd2aa4feabff4af21a997d5d8aa23}{DEBUG\_PRINT}}(String(\textcolor{stringliteral}{"{}AP SSID: "{}}) + ssidBuff);}
\DoxyCodeLine{109   \mbox{\hyperlink{_d_h_t_8h_a88edd2aa4feabff4af21a997d5d8aa23}{DEBUG\_PRINT}}(String(\textcolor{stringliteral}{"{}AP IP:   "{}}) + myIP[0] + \textcolor{stringliteral}{"{}."{}} + myIP[1] + \textcolor{stringliteral}{"{}."{}} + myIP[2] + \textcolor{stringliteral}{"{}."{}} + myIP[3]);}
\DoxyCodeLine{110 }
\DoxyCodeLine{111   \textcolor{comment}{// Set up DNS Server}}
\DoxyCodeLine{112   dnsServer.setTTL(300); \textcolor{comment}{// Time-\/to-\/live 300s}}
\DoxyCodeLine{113   dnsServer.setErrorReplyCode(DNSReplyCode::ServerFailure); \textcolor{comment}{// Return code for non-\/accessible domains}}
\DoxyCodeLine{114 \textcolor{preprocessor}{\#ifdef WIFI\_CAPTIVE\_PORTAL\_ENABLE}}
\DoxyCodeLine{115   dnsServer.start(DNS\_PORT, \textcolor{stringliteral}{"{}*"{}}, WiFi.softAPIP()); \textcolor{comment}{// Point all to our IP}}
\DoxyCodeLine{116   server.onNotFound(handleRoot);}
\DoxyCodeLine{117 \textcolor{preprocessor}{\#else}}
\DoxyCodeLine{118   dnsServer.start(DNS\_PORT, CONFIG\_AP\_URL, WiFi.softAPIP());}
\DoxyCodeLine{119   \mbox{\hyperlink{_d_h_t_8h_a88edd2aa4feabff4af21a997d5d8aa23}{DEBUG\_PRINT}}(String(\textcolor{stringliteral}{"{}AP URL:  "{}}) + CONFIG\_AP\_URL);}
\DoxyCodeLine{120 \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{121 }
\DoxyCodeLine{122   server.on(\textcolor{stringliteral}{"{}/config"{}}, []() \{}
\DoxyCodeLine{123     \mbox{\hyperlink{_d_h_t_8h_a88edd2aa4feabff4af21a997d5d8aa23}{DEBUG\_PRINT}}(\textcolor{stringliteral}{"{}Applying configuration..."{}});}
\DoxyCodeLine{124     String ssid = server.arg(\textcolor{stringliteral}{"{}ssid"{}});}
\DoxyCodeLine{125     String ssidManual = server.arg(\textcolor{stringliteral}{"{}ssidManual"{}});}
\DoxyCodeLine{126     String pass = server.arg(\textcolor{stringliteral}{"{}pass"{}});}
\DoxyCodeLine{127     \textcolor{keywordflow}{if} (ssidManual != \textcolor{stringliteral}{"{}"{}}) \{}
\DoxyCodeLine{128       ssid = ssidManual;}
\DoxyCodeLine{129     \}}
\DoxyCodeLine{130     String token = server.arg(\textcolor{stringliteral}{"{}blynk"{}});}
\DoxyCodeLine{131     String host  = server.arg(\textcolor{stringliteral}{"{}host"{}});}
\DoxyCodeLine{132     String port  = server.arg(\textcolor{stringliteral}{"{}port\_ssl"{}});}
\DoxyCodeLine{133 }
\DoxyCodeLine{134     String ip   = server.arg(\textcolor{stringliteral}{"{}ip"{}});}
\DoxyCodeLine{135     String mask = server.arg(\textcolor{stringliteral}{"{}mask"{}});}
\DoxyCodeLine{136     String gw   = server.arg(\textcolor{stringliteral}{"{}gw"{}});}
\DoxyCodeLine{137     String dns  = server.arg(\textcolor{stringliteral}{"{}dns"{}});}
\DoxyCodeLine{138     String dns2 = server.arg(\textcolor{stringliteral}{"{}dns2"{}});}
\DoxyCodeLine{139 }
\DoxyCodeLine{140     \textcolor{keywordtype}{bool} save  = server.arg(\textcolor{stringliteral}{"{}save"{}}).toInt();}
\DoxyCodeLine{141 }
\DoxyCodeLine{142     String content;}
\DoxyCodeLine{143 }
\DoxyCodeLine{144     \mbox{\hyperlink{_d_h_t_8h_a88edd2aa4feabff4af21a997d5d8aa23}{DEBUG\_PRINT}}(String(\textcolor{stringliteral}{"{}WiFi SSID: "{}}) + ssid + \textcolor{stringliteral}{"{} Pass: "{}} + pass);}
\DoxyCodeLine{145     \mbox{\hyperlink{_d_h_t_8h_a88edd2aa4feabff4af21a997d5d8aa23}{DEBUG\_PRINT}}(String(\textcolor{stringliteral}{"{}Blynk cloud: "{}}) + token + \textcolor{stringliteral}{"{} @ "{}} + host + \textcolor{stringliteral}{"{}:"{}} + port);}
\DoxyCodeLine{146 }
\DoxyCodeLine{147     \textcolor{keywordflow}{if} (token.length() == 32 \&\& ssid.length() > 0) \{}
\DoxyCodeLine{148       configStore.setFlag(CONFIG\_FLAG\_VALID, \textcolor{keyword}{false});}
\DoxyCodeLine{149       CopyString(ssid, configStore.wifiSSID);}
\DoxyCodeLine{150       CopyString(pass, configStore.wifiPass);}
\DoxyCodeLine{151       CopyString(token, configStore.cloudToken);}
\DoxyCodeLine{152       \textcolor{keywordflow}{if} (host.length()) \{}
\DoxyCodeLine{153         CopyString(host,  configStore.cloudHost);}
\DoxyCodeLine{154       \}}
\DoxyCodeLine{155       \textcolor{keywordflow}{if} (port.length()) \{}
\DoxyCodeLine{156         configStore.cloudPort = port.toInt();}
\DoxyCodeLine{157       \}}
\DoxyCodeLine{158 }
\DoxyCodeLine{159       IPAddress addr;}
\DoxyCodeLine{160       }
\DoxyCodeLine{161       \textcolor{keywordflow}{if} (ip.length() \&\& addr.fromString(ip)) \{}
\DoxyCodeLine{162         configStore.staticIP = addr;}
\DoxyCodeLine{163         configStore.setFlag(CONFIG\_FLAG\_STATIC\_IP, \textcolor{keyword}{true});}
\DoxyCodeLine{164       \} \textcolor{keywordflow}{else} \{}
\DoxyCodeLine{165         configStore.setFlag(CONFIG\_FLAG\_STATIC\_IP, \textcolor{keyword}{false});}
\DoxyCodeLine{166       \}}
\DoxyCodeLine{167       \textcolor{keywordflow}{if} (mask.length() \&\& addr.fromString(mask)) \{}
\DoxyCodeLine{168         configStore.staticMask = addr;}
\DoxyCodeLine{169       \}}
\DoxyCodeLine{170       \textcolor{keywordflow}{if} (gw.length() \&\& addr.fromString(gw)) \{}
\DoxyCodeLine{171         configStore.staticGW = addr;}
\DoxyCodeLine{172       \}}
\DoxyCodeLine{173       \textcolor{keywordflow}{if} (dns.length() \&\& addr.fromString(dns)) \{}
\DoxyCodeLine{174         configStore.staticDNS = addr;}
\DoxyCodeLine{175       \}}
\DoxyCodeLine{176       \textcolor{keywordflow}{if} (dns2.length() \&\& addr.fromString(dns2)) \{}
\DoxyCodeLine{177         configStore.staticDNS2 = addr;}
\DoxyCodeLine{178       \}}
\DoxyCodeLine{179 }
\DoxyCodeLine{180       \textcolor{keywordflow}{if} (save) \{}
\DoxyCodeLine{181         configStore.setFlag(CONFIG\_FLAG\_VALID, \textcolor{keyword}{true});}
\DoxyCodeLine{182         config\_save();}
\DoxyCodeLine{183 }
\DoxyCodeLine{184         content = R\textcolor{stringliteral}{"{}json(\{"{}status"{}:"{}ok"{},"{}msg"{}:"{}Configuration saved"{}\})json"{};}}
\DoxyCodeLine{185 \textcolor{stringliteral}{      \} }\textcolor{keywordflow}{else} \{}
\DoxyCodeLine{186         content = R\textcolor{stringliteral}{"{}json(\{"{}status"{}:"{}ok"{},"{}msg"{}:"{}Trying to connect..."{}\})json"{};}}
\DoxyCodeLine{187 \textcolor{stringliteral}{      \}}}
\DoxyCodeLine{188 \textcolor{stringliteral}{      server.send(200, }\textcolor{stringliteral}{"{}application/json"{}}, content);}
\DoxyCodeLine{189 }
\DoxyCodeLine{190       BlynkState::set(MODE\_SWITCH\_TO\_STA);}
\DoxyCodeLine{191     \} \textcolor{keywordflow}{else} \{}
\DoxyCodeLine{192       \mbox{\hyperlink{_d_h_t_8h_a88edd2aa4feabff4af21a997d5d8aa23}{DEBUG\_PRINT}}(\textcolor{stringliteral}{"{}Configuration invalid"{}});}
\DoxyCodeLine{193       content = R\textcolor{stringliteral}{"{}json(\{"{}status"{}:"{}error"{},"{}msg"{}:"{}Configuration invalid"{}\})json"{};}}
\DoxyCodeLine{194 \textcolor{stringliteral}{      server.send(500, }\textcolor{stringliteral}{"{}application/json"{}}, content);}
\DoxyCodeLine{195     \}}
\DoxyCodeLine{196   \});}
\DoxyCodeLine{197   server.on(\textcolor{stringliteral}{"{}/board\_info.json"{}}, []() \{}
\DoxyCodeLine{198     \mbox{\hyperlink{_d_h_t_8h_a88edd2aa4feabff4af21a997d5d8aa23}{DEBUG\_PRINT}}(\textcolor{stringliteral}{"{}Sending board info..."{}});}
\DoxyCodeLine{199     \textcolor{keyword}{const} \textcolor{keywordtype}{char}* tmpl = BLYNK\_TEMPLATE\_ID;}
\DoxyCodeLine{200     \textcolor{keywordtype}{char} ssidBuff[64];}
\DoxyCodeLine{201     getWiFiName(ssidBuff, \textcolor{keyword}{sizeof}(ssidBuff));}
\DoxyCodeLine{202     \textcolor{keywordtype}{char} buff[512];}
\DoxyCodeLine{203     snprintf(buff, \textcolor{keyword}{sizeof}(buff),}
\DoxyCodeLine{204       R\textcolor{stringliteral}{"{}json(\{"{}board"{}:"{}\%s"{},"{}tmpl\_id"{}:"{}\%s"{},"{}fw\_type"{}:"{}\%s"{},"{}fw\_ver"{}:"{}\%s"{},"{}ssid"{}:"{}\%s"{},"{}bssid"{}:"{}\%s"{},"{}last\_error"{}:\%d,"{}wifi\_scan"{}:true,"{}static\_ip"{}:true\})json"{},}}
\DoxyCodeLine{205 \textcolor{stringliteral}{      BLYNK\_DEVICE\_NAME,}}
\DoxyCodeLine{206 \textcolor{stringliteral}{      tmpl ? tmpl : }\textcolor{stringliteral}{"{}Unknown"{}},}
\DoxyCodeLine{207       BLYNK\_FIRMWARE\_TYPE,}
\DoxyCodeLine{208       BLYNK\_FIRMWARE\_VERSION,}
\DoxyCodeLine{209       ssidBuff,}
\DoxyCodeLine{210       WiFi.softAPmacAddress().c\_str(),}
\DoxyCodeLine{211       configStore.last\_error}
\DoxyCodeLine{212     );}
\DoxyCodeLine{213     server.send(200, \textcolor{stringliteral}{"{}application/json"{}}, buff);}
\DoxyCodeLine{214   \});}
\DoxyCodeLine{215   server.on(\textcolor{stringliteral}{"{}/wifi\_scan.json"{}}, []() \{}
\DoxyCodeLine{216     \mbox{\hyperlink{_d_h_t_8h_a88edd2aa4feabff4af21a997d5d8aa23}{DEBUG\_PRINT}}(\textcolor{stringliteral}{"{}Scanning networks..."{}});}
\DoxyCodeLine{217     \textcolor{keywordtype}{int} wifi\_nets = WiFi.scanNetworks(\textcolor{keyword}{true}, \textcolor{keyword}{true});}
\DoxyCodeLine{218     \textcolor{keyword}{const} uint32\_t t = millis();}
\DoxyCodeLine{219     \textcolor{keywordflow}{while} (wifi\_nets < 0 \&\&}
\DoxyCodeLine{220            millis() -\/ t < 20000)}
\DoxyCodeLine{221     \{}
\DoxyCodeLine{222       delay(20);}
\DoxyCodeLine{223       wifi\_nets = WiFi.scanComplete();}
\DoxyCodeLine{224     \}}
\DoxyCodeLine{225     \mbox{\hyperlink{_d_h_t_8h_a88edd2aa4feabff4af21a997d5d8aa23}{DEBUG\_PRINT}}(String(\textcolor{stringliteral}{"{}Found networks: "{}}) + wifi\_nets);}
\DoxyCodeLine{226 }
\DoxyCodeLine{227     \textcolor{keywordflow}{if} (wifi\_nets > 0) \{}
\DoxyCodeLine{228       \textcolor{comment}{// Sort networks}}
\DoxyCodeLine{229       \textcolor{keywordtype}{int} indices[wifi\_nets];}
\DoxyCodeLine{230       \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} i = 0; i < wifi\_nets; i++) \{}
\DoxyCodeLine{231         indices[i] = i;}
\DoxyCodeLine{232       \}}
\DoxyCodeLine{233       \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} i = 0; i < wifi\_nets; i++) \{}
\DoxyCodeLine{234         \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} j = i + 1; j < wifi\_nets; j++) \{}
\DoxyCodeLine{235           \textcolor{keywordflow}{if} (WiFi.RSSI(indices[j]) > WiFi.RSSI(indices[i])) \{}
\DoxyCodeLine{236             std::swap(indices[i], indices[j]);}
\DoxyCodeLine{237           \}}
\DoxyCodeLine{238         \}}
\DoxyCodeLine{239       \}}
\DoxyCodeLine{240 }
\DoxyCodeLine{241       wifi\_nets = BlynkMin(15, wifi\_nets); \textcolor{comment}{// Show top 15 networks}}
\DoxyCodeLine{242 }
\DoxyCodeLine{243       \textcolor{comment}{// TODO: skip empty names}}
\DoxyCodeLine{244       String result = \textcolor{stringliteral}{"{}[\(\backslash\)n"{}};}
\DoxyCodeLine{245 }
\DoxyCodeLine{246       \textcolor{keywordtype}{char} buff[256];}
\DoxyCodeLine{247       \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} i = 0; i < wifi\_nets; i++)\{}
\DoxyCodeLine{248         \textcolor{keywordtype}{int} \textcolor{keywordtype}{id} = indices[i];}
\DoxyCodeLine{249 }
\DoxyCodeLine{250         \textcolor{keyword}{const} \textcolor{keywordtype}{char}* sec;}
\DoxyCodeLine{251         \textcolor{keywordflow}{switch} (WiFi.encryptionType(\textcolor{keywordtype}{id})) \{}
\DoxyCodeLine{252         \textcolor{keywordflow}{case} WIFI\_AUTH\_WEP:          sec = \textcolor{stringliteral}{"{}WEP"{}}; \textcolor{keywordflow}{break};}
\DoxyCodeLine{253         \textcolor{keywordflow}{case} WIFI\_AUTH\_WPA\_PSK:      sec = \textcolor{stringliteral}{"{}WPA/PSK"{}}; \textcolor{keywordflow}{break};}
\DoxyCodeLine{254         \textcolor{keywordflow}{case} WIFI\_AUTH\_WPA2\_PSK:     sec = \textcolor{stringliteral}{"{}WPA2/PSK"{}}; \textcolor{keywordflow}{break};}
\DoxyCodeLine{255         \textcolor{keywordflow}{case} WIFI\_AUTH\_WPA\_WPA2\_PSK: sec = \textcolor{stringliteral}{"{}WPA/WPA2/PSK"{}}; \textcolor{keywordflow}{break};}
\DoxyCodeLine{256         \textcolor{keywordflow}{case} WIFI\_AUTH\_OPEN:         sec = \textcolor{stringliteral}{"{}OPEN"{}}; \textcolor{keywordflow}{break};}
\DoxyCodeLine{257         \textcolor{keywordflow}{default}:                     sec = \textcolor{stringliteral}{"{}unknown"{}}; \textcolor{keywordflow}{break};}
\DoxyCodeLine{258         \}}
\DoxyCodeLine{259 }
\DoxyCodeLine{260         snprintf(buff, \textcolor{keyword}{sizeof}(buff),}
\DoxyCodeLine{261           R\textcolor{stringliteral}{"{}json(  \{"{}ssid"{}:"{}\%s"{},"{}bssid"{}:"{}\%s"{},"{}rssi"{}:\%i,"{}sec"{}:"{}\%s"{},"{}ch"{}:\%i\})json"{},}}
\DoxyCodeLine{262 \textcolor{stringliteral}{          WiFi.SSID(}\textcolor{keywordtype}{id}).c\_str(),}
\DoxyCodeLine{263           WiFi.BSSIDstr(\textcolor{keywordtype}{id}).c\_str(),}
\DoxyCodeLine{264           WiFi.RSSI(\textcolor{keywordtype}{id}),}
\DoxyCodeLine{265           sec,}
\DoxyCodeLine{266           WiFi.channel(\textcolor{keywordtype}{id})}
\DoxyCodeLine{267         );}
\DoxyCodeLine{268 }
\DoxyCodeLine{269         result += buff;}
\DoxyCodeLine{270         \textcolor{keywordflow}{if} (i != wifi\_nets-\/1) result += \textcolor{stringliteral}{"{},\(\backslash\)n"{}};}
\DoxyCodeLine{271       \}}
\DoxyCodeLine{272       server.send(200, \textcolor{stringliteral}{"{}application/json"{}}, result + \textcolor{stringliteral}{"{}\(\backslash\)n]"{}});}
\DoxyCodeLine{273     \} \textcolor{keywordflow}{else} \{}
\DoxyCodeLine{274       server.send(200, \textcolor{stringliteral}{"{}application/json"{}}, \textcolor{stringliteral}{"{}[]"{}});}
\DoxyCodeLine{275     \}}
\DoxyCodeLine{276   \});}
\DoxyCodeLine{277   server.on(\textcolor{stringliteral}{"{}/reset"{}}, []() \{}
\DoxyCodeLine{278     BlynkState::set(MODE\_RESET\_CONFIG);}
\DoxyCodeLine{279     server.send(200, \textcolor{stringliteral}{"{}application/json"{}}, R\textcolor{stringliteral}{"{}json(\{"{}status"{}:"{}ok"{},"{}msg"{}:"{}Configuration reset"{}\})json"{});}}
\DoxyCodeLine{280 \textcolor{stringliteral}{  \});}}
\DoxyCodeLine{281 \textcolor{stringliteral}{  server.on(}\textcolor{stringliteral}{"{}/reboot"{}}, []() \{}
\DoxyCodeLine{282     restartMCU();}
\DoxyCodeLine{283   \});}
\DoxyCodeLine{284 }
\DoxyCodeLine{285 \textcolor{preprocessor}{\#ifdef BLYNK\_USE\_SPIFFS}}
\DoxyCodeLine{286   \textcolor{keywordflow}{if} (SPIFFS.begin()) \{}
\DoxyCodeLine{287     server.serveStatic(\textcolor{stringliteral}{"{}/img/favicon.png"{}}, SPIFFS, \textcolor{stringliteral}{"{}/img/favicon.png"{}});}
\DoxyCodeLine{288     server.serveStatic(\textcolor{stringliteral}{"{}/img/logo.png"{}}, SPIFFS, \textcolor{stringliteral}{"{}/img/logo.png"{}});}
\DoxyCodeLine{289     server.serveStatic(\textcolor{stringliteral}{"{}/"{}}, SPIFFS, \textcolor{stringliteral}{"{}/index.html"{}});}
\DoxyCodeLine{290   \} \textcolor{keywordflow}{else} \{}
\DoxyCodeLine{291     \mbox{\hyperlink{_d_h_t_8h_a88edd2aa4feabff4af21a997d5d8aa23}{DEBUG\_PRINT}}(\textcolor{stringliteral}{"{}Webpage: No SPIFFS"{}});}
\DoxyCodeLine{292   \}}
\DoxyCodeLine{293 \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{294 }
\DoxyCodeLine{295   server.begin();}
\DoxyCodeLine{296 }
\DoxyCodeLine{297   \textcolor{keywordflow}{while} (BlynkState::is(MODE\_WAIT\_CONFIG) || BlynkState::is(MODE\_CONFIGURING)) \{}
\DoxyCodeLine{298     delay(10);}
\DoxyCodeLine{299     dnsServer.processNextRequest();}
\DoxyCodeLine{300     server.handleClient();}
\DoxyCodeLine{301     app\_loop();}
\DoxyCodeLine{302     \textcolor{keywordflow}{if} (BlynkState::is(MODE\_WAIT\_CONFIG) \&\& WiFi.softAPgetStationNum() > 0) \{}
\DoxyCodeLine{303       BlynkState::set(MODE\_CONFIGURING);}
\DoxyCodeLine{304     \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (BlynkState::is(MODE\_CONFIGURING) \&\& WiFi.softAPgetStationNum() == 0) \{}
\DoxyCodeLine{305       BlynkState::set(MODE\_WAIT\_CONFIG);}
\DoxyCodeLine{306     \}}
\DoxyCodeLine{307   \}}
\DoxyCodeLine{308 }
\DoxyCodeLine{309   server.stop();}
\DoxyCodeLine{310   }
\DoxyCodeLine{311 \textcolor{preprocessor}{\#ifdef BLYNK\_USE\_SPIFFS}}
\DoxyCodeLine{312   SPIFFS.end();}
\DoxyCodeLine{313 \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{314 \}}
\DoxyCodeLine{315 }
\DoxyCodeLine{316 \textcolor{keywordtype}{void} enterConnectNet() \{}
\DoxyCodeLine{317   BlynkState::set(MODE\_CONNECTING\_NET);}
\DoxyCodeLine{318   \mbox{\hyperlink{_d_h_t_8h_a88edd2aa4feabff4af21a997d5d8aa23}{DEBUG\_PRINT}}(String(\textcolor{stringliteral}{"{}Connecting to WiFi: "{}}) + configStore.wifiSSID);}
\DoxyCodeLine{319 }
\DoxyCodeLine{320   \textcolor{keywordtype}{char} ssidBuff[64];}
\DoxyCodeLine{321   getWiFiName(ssidBuff, \textcolor{keyword}{sizeof}(ssidBuff));}
\DoxyCodeLine{322   String hostname(ssidBuff);}
\DoxyCodeLine{323   hostname.replace(\textcolor{stringliteral}{"{} "{}}, \textcolor{stringliteral}{"{}-\/"{}});}
\DoxyCodeLine{324   WiFi.setHostname(hostname.c\_str());}
\DoxyCodeLine{325 }
\DoxyCodeLine{326   \textcolor{keywordflow}{if} (configStore.getFlag(CONFIG\_FLAG\_STATIC\_IP)) \{}
\DoxyCodeLine{327     \textcolor{keywordflow}{if} (!WiFi.config(configStore.staticIP,}
\DoxyCodeLine{328                     configStore.staticGW,}
\DoxyCodeLine{329                     configStore.staticMask,}
\DoxyCodeLine{330                     configStore.staticDNS,}
\DoxyCodeLine{331                     configStore.staticDNS2)}
\DoxyCodeLine{332     ) \{}
\DoxyCodeLine{333       \mbox{\hyperlink{_d_h_t_8h_a88edd2aa4feabff4af21a997d5d8aa23}{DEBUG\_PRINT}}(\textcolor{stringliteral}{"{}Failed to configure Static IP"{}});}
\DoxyCodeLine{334       config\_set\_last\_error(BLYNK\_PROV\_ERR\_CONFIG);}
\DoxyCodeLine{335       BlynkState::set(MODE\_ERROR);}
\DoxyCodeLine{336       \textcolor{keywordflow}{return};}
\DoxyCodeLine{337     \}}
\DoxyCodeLine{338   \}}
\DoxyCodeLine{339 }
\DoxyCodeLine{340   WiFi.begin(configStore.wifiSSID, configStore.wifiPass);}
\DoxyCodeLine{341 }
\DoxyCodeLine{342   \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{long} timeoutMs = millis() + WIFI\_NET\_CONNECT\_TIMEOUT;}
\DoxyCodeLine{343   \textcolor{keywordflow}{while} ((timeoutMs > millis()) \&\& (WiFi.status() != WL\_CONNECTED))}
\DoxyCodeLine{344   \{}
\DoxyCodeLine{345     delay(10);}
\DoxyCodeLine{346     app\_loop();}
\DoxyCodeLine{347 }
\DoxyCodeLine{348     \textcolor{keywordflow}{if} (!BlynkState::is(MODE\_CONNECTING\_NET)) \{}
\DoxyCodeLine{349       WiFi.disconnect();}
\DoxyCodeLine{350       \textcolor{keywordflow}{return};}
\DoxyCodeLine{351     \}}
\DoxyCodeLine{352   \}}
\DoxyCodeLine{353 }
\DoxyCodeLine{354   \textcolor{keywordflow}{if} (WiFi.status() == WL\_CONNECTED) \{}
\DoxyCodeLine{355     IPAddress localip = WiFi.localIP();}
\DoxyCodeLine{356     \textcolor{keywordflow}{if} (configStore.getFlag(CONFIG\_FLAG\_STATIC\_IP)) \{}
\DoxyCodeLine{357       BLYNK\_LOG\_IP(\textcolor{stringliteral}{"{}Using Static IP: "{}}, localip);}
\DoxyCodeLine{358     \} \textcolor{keywordflow}{else} \{}
\DoxyCodeLine{359       BLYNK\_LOG\_IP(\textcolor{stringliteral}{"{}Using Dynamic IP: "{}}, localip);}
\DoxyCodeLine{360     \}}
\DoxyCodeLine{361 }
\DoxyCodeLine{362     BlynkState::set(MODE\_CONNECTING\_CLOUD);}
\DoxyCodeLine{363   \} \textcolor{keywordflow}{else} \{}
\DoxyCodeLine{364     config\_set\_last\_error(BLYNK\_PROV\_ERR\_NETWORK);}
\DoxyCodeLine{365     BlynkState::set(MODE\_ERROR);}
\DoxyCodeLine{366   \}}
\DoxyCodeLine{367 \}}
\DoxyCodeLine{368 }
\DoxyCodeLine{369 \textcolor{keywordtype}{void} enterConnectCloud() \{}
\DoxyCodeLine{370   BlynkState::set(MODE\_CONNECTING\_CLOUD);}
\DoxyCodeLine{371 }
\DoxyCodeLine{372   Blynk.config(configStore.cloudToken, configStore.cloudHost, configStore.cloudPort);}
\DoxyCodeLine{373   Blynk.connect(0);}
\DoxyCodeLine{374 }
\DoxyCodeLine{375   \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{long} timeoutMs = millis() + WIFI\_CLOUD\_CONNECT\_TIMEOUT;}
\DoxyCodeLine{376   \textcolor{keywordflow}{while} ((timeoutMs > millis()) \&\&}
\DoxyCodeLine{377         (!Blynk.isTokenInvalid()) \&\&}
\DoxyCodeLine{378         (Blynk.connected() == \textcolor{keyword}{false}))}
\DoxyCodeLine{379   \{}
\DoxyCodeLine{380     delay(10);}
\DoxyCodeLine{381     Blynk.run();}
\DoxyCodeLine{382     app\_loop();}
\DoxyCodeLine{383     \textcolor{keywordflow}{if} (!BlynkState::is(MODE\_CONNECTING\_CLOUD)) \{}
\DoxyCodeLine{384       Blynk.disconnect();}
\DoxyCodeLine{385       \textcolor{keywordflow}{return};}
\DoxyCodeLine{386     \}}
\DoxyCodeLine{387   \}}
\DoxyCodeLine{388 }
\DoxyCodeLine{389   \textcolor{keywordflow}{if} (millis() > timeoutMs) \{}
\DoxyCodeLine{390     \mbox{\hyperlink{_d_h_t_8h_a88edd2aa4feabff4af21a997d5d8aa23}{DEBUG\_PRINT}}(\textcolor{stringliteral}{"{}Timeout"{}});}
\DoxyCodeLine{391   \}}
\DoxyCodeLine{392 }
\DoxyCodeLine{393   \textcolor{keywordflow}{if} (Blynk.isTokenInvalid()) \{}
\DoxyCodeLine{394     config\_set\_last\_error(BLYNK\_PROV\_ERR\_TOKEN);}
\DoxyCodeLine{395     BlynkState::set(MODE\_WAIT\_CONFIG);}
\DoxyCodeLine{396   \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (Blynk.connected()) \{}
\DoxyCodeLine{397     BlynkState::set(MODE\_RUNNING);}
\DoxyCodeLine{398 }
\DoxyCodeLine{399     \textcolor{keywordflow}{if} (!configStore.getFlag(CONFIG\_FLAG\_VALID)) \{}
\DoxyCodeLine{400       configStore.last\_error = BLYNK\_PROV\_ERR\_NONE;}
\DoxyCodeLine{401       configStore.setFlag(CONFIG\_FLAG\_VALID, \textcolor{keyword}{true});}
\DoxyCodeLine{402       config\_save();}
\DoxyCodeLine{403     \}}
\DoxyCodeLine{404   \} \textcolor{keywordflow}{else} \{}
\DoxyCodeLine{405     config\_set\_last\_error(BLYNK\_PROV\_ERR\_CLOUD);}
\DoxyCodeLine{406     BlynkState::set(MODE\_ERROR);}
\DoxyCodeLine{407   \}}
\DoxyCodeLine{408 \}}
\DoxyCodeLine{409 }
\DoxyCodeLine{410 \textcolor{keywordtype}{void} enterSwitchToSTA() \{}
\DoxyCodeLine{411   BlynkState::set(MODE\_SWITCH\_TO\_STA);}
\DoxyCodeLine{412 }
\DoxyCodeLine{413   \mbox{\hyperlink{_d_h_t_8h_a88edd2aa4feabff4af21a997d5d8aa23}{DEBUG\_PRINT}}(\textcolor{stringliteral}{"{}Switching to STA..."{}});}
\DoxyCodeLine{414 }
\DoxyCodeLine{415   delay(1000);}
\DoxyCodeLine{416   WiFi.mode(WIFI\_OFF);}
\DoxyCodeLine{417   delay(100);}
\DoxyCodeLine{418   WiFi.mode(WIFI\_STA);}
\DoxyCodeLine{419 }
\DoxyCodeLine{420   BlynkState::set(MODE\_CONNECTING\_NET);}
\DoxyCodeLine{421 \}}
\DoxyCodeLine{422 }
\DoxyCodeLine{423 \textcolor{keywordtype}{void} enterError() \{}
\DoxyCodeLine{424   BlynkState::set(MODE\_ERROR);}
\DoxyCodeLine{425   }
\DoxyCodeLine{426   \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{long} timeoutMs = millis() + 10000;}
\DoxyCodeLine{427   \textcolor{keywordflow}{while} (timeoutMs > millis() || g\_buttonPressed)}
\DoxyCodeLine{428   \{}
\DoxyCodeLine{429     delay(10);}
\DoxyCodeLine{430     app\_loop();}
\DoxyCodeLine{431     \textcolor{keywordflow}{if} (!BlynkState::is(MODE\_ERROR)) \{}
\DoxyCodeLine{432       \textcolor{keywordflow}{return};}
\DoxyCodeLine{433     \}}
\DoxyCodeLine{434   \}}
\DoxyCodeLine{435   \mbox{\hyperlink{_d_h_t_8h_a88edd2aa4feabff4af21a997d5d8aa23}{DEBUG\_PRINT}}(\textcolor{stringliteral}{"{}Restarting after error."{}});}
\DoxyCodeLine{436   delay(10);}
\DoxyCodeLine{437 }
\DoxyCodeLine{438   restartMCU();}
\DoxyCodeLine{439 \}}
\DoxyCodeLine{440 }

\end{DoxyCode}
