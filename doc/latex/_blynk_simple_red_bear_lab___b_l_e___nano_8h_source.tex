\hypertarget{_blynk_simple_red_bear_lab___b_l_e___nano_8h_source}{}\doxysection{Blynk\+Simple\+Red\+Bear\+Lab\+\_\+\+BLE\+\_\+\+Nano.\+h}
\label{_blynk_simple_red_bear_lab___b_l_e___nano_8h_source}\index{lib/Blynk/src/BlynkSimpleRedBearLab\_BLE\_Nano.h@{lib/Blynk/src/BlynkSimpleRedBearLab\_BLE\_Nano.h}}
\mbox{\hyperlink{_blynk_simple_red_bear_lab___b_l_e___nano_8h}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{1 }
\DoxyCodeLine{11 \textcolor{preprocessor}{\#ifndef BlynkSimpleRedBearLab\_BLE\_Nano\_h}}
\DoxyCodeLine{12 \textcolor{preprocessor}{\#define BlynkSimpleRedBearLab\_BLE\_Nano\_h}}
\DoxyCodeLine{13 }
\DoxyCodeLine{14 \textcolor{preprocessor}{\#ifndef BLYNK\_INFO\_CONNECTION}}
\DoxyCodeLine{15 \textcolor{preprocessor}{\#define BLYNK\_INFO\_CONNECTION "{}RBL\_BLE\_Nano"{}}}
\DoxyCodeLine{16 \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{17 }
\DoxyCodeLine{18 \textcolor{preprocessor}{\#define BLYNK\_SEND\_ATOMIC}}
\DoxyCodeLine{19 \textcolor{preprocessor}{\#define BLYNK\_SEND\_CHUNK 20}}
\DoxyCodeLine{20 \textcolor{preprocessor}{\#define BLYNK\_SEND\_THROTTLE 20}}
\DoxyCodeLine{21 }
\DoxyCodeLine{22 \textcolor{preprocessor}{\#include <\mbox{\hyperlink{_blynk_api_arduino_8h}{BlynkApiArduino.h}}>}}
\DoxyCodeLine{23 \textcolor{preprocessor}{\#include <\mbox{\hyperlink{_blynk_protocol_8h}{Blynk/BlynkProtocol.h}}>}}
\DoxyCodeLine{24 \textcolor{preprocessor}{\#include <\mbox{\hyperlink{_blynk_fifo_8h}{utility/BlynkFifo.h}}>}}
\DoxyCodeLine{25 \textcolor{preprocessor}{\#include <BLE\_API.h>}}
\DoxyCodeLine{26 }
\DoxyCodeLine{27 \textcolor{comment}{/*}}
\DoxyCodeLine{28 \textcolor{comment}{ * The Nordic UART Service}}
\DoxyCodeLine{29 \textcolor{comment}{ */}}
\DoxyCodeLine{30 \textcolor{keyword}{static} \textcolor{keyword}{const} uint8\_t uart\_base\_uuid[]     = \{0x71, 0x3D, 0, 0, 0x50, 0x3E, 0x4C, 0x75, 0xBA, 0x94, 0x31, 0x48, 0xF1, 0x8D, 0x94, 0x1E\};}
\DoxyCodeLine{31 \textcolor{keyword}{static} \textcolor{keyword}{const} uint8\_t uart\_base\_uuid\_rev[] = \{0x1E, 0x94, 0x8D, 0xF1, 0x48, 0x31, 0x94, 0xBA, 0x75, 0x4C, 0x3E, 0x50, 0, 0, 0x3D, 0x71\};}
\DoxyCodeLine{32 \textcolor{keyword}{static} \textcolor{keyword}{const} uint8\_t uart\_tx\_uuid[]       = \{0x71, 0x3D, 0, 3, 0x50, 0x3E, 0x4C, 0x75, 0xBA, 0x94, 0x31, 0x48, 0xF1, 0x8D, 0x94, 0x1E\};}
\DoxyCodeLine{33 \textcolor{keyword}{static} \textcolor{keyword}{const} uint8\_t uart\_rx\_uuid[]       = \{0x71, 0x3D, 0, 2, 0x50, 0x3E, 0x4C, 0x75, 0xBA, 0x94, 0x31, 0x48, 0xF1, 0x8D, 0x94, 0x1E\};}
\DoxyCodeLine{34 \textcolor{keyword}{static} \textcolor{keyword}{const} uint8\_t uart\_dev\_name[]      = \textcolor{stringliteral}{"{}Blynk"{}};}
\DoxyCodeLine{35 }
\DoxyCodeLine{36 \textcolor{preprocessor}{\#define TXRX\_BUF\_LEN 20}}
\DoxyCodeLine{37 uint8\_t txPayload[TXRX\_BUF\_LEN] = \{0,\};}
\DoxyCodeLine{38 uint8\_t rxPayload[TXRX\_BUF\_LEN] = \{0,\};}
\DoxyCodeLine{39 }
\DoxyCodeLine{40 GattCharacteristic  txCharacteristic (uart\_tx\_uuid, txPayload, 1, TXRX\_BUF\_LEN,}
\DoxyCodeLine{41                                       GattCharacteristic::BLE\_GATT\_CHAR\_PROPERTIES\_WRITE |}
\DoxyCodeLine{42                                       GattCharacteristic::BLE\_GATT\_CHAR\_PROPERTIES\_WRITE\_WITHOUT\_RESPONSE);}
\DoxyCodeLine{43 }
\DoxyCodeLine{44 GattCharacteristic  rxCharacteristic (uart\_rx\_uuid, rxPayload, 1, TXRX\_BUF\_LEN,}
\DoxyCodeLine{45                                       GattCharacteristic::BLE\_GATT\_CHAR\_PROPERTIES\_NOTIFY);}
\DoxyCodeLine{46 }
\DoxyCodeLine{47 GattCharacteristic *uartChars[] = \{\&txCharacteristic, \&rxCharacteristic\};}
\DoxyCodeLine{48 }
\DoxyCodeLine{49 GattService         uartService(uart\_base\_uuid, uartChars, \textcolor{keyword}{sizeof}(uartChars) / \textcolor{keyword}{sizeof}(GattCharacteristic*));}
\DoxyCodeLine{50 }
\DoxyCodeLine{51 BLE  ble;}
\DoxyCodeLine{52 }
\DoxyCodeLine{53 \textcolor{keyword}{class }\mbox{\hyperlink{class_blynk_transport_red_bear_lab___b_l_e___nano}{BlynkTransportRedBearLab\_BLE\_Nano}}}
\DoxyCodeLine{54 \{}
\DoxyCodeLine{55 \textcolor{keyword}{public}:}
\DoxyCodeLine{56     \mbox{\hyperlink{class_blynk_transport_red_bear_lab___b_l_e___nano}{BlynkTransportRedBearLab\_BLE\_Nano}}()}
\DoxyCodeLine{57         : mConn (\textcolor{keyword}{false})}
\DoxyCodeLine{58     \{\}}
\DoxyCodeLine{59 }
\DoxyCodeLine{60     \textcolor{comment}{// IP redirect not available}}
\DoxyCodeLine{61     \textcolor{keywordtype}{void} begin(\textcolor{keywordtype}{char}* h, uint16\_t p) \{\}}
\DoxyCodeLine{62 }
\DoxyCodeLine{63     \textcolor{keywordtype}{void} begin() \{}
\DoxyCodeLine{64         instance = \textcolor{keyword}{this};}
\DoxyCodeLine{65 }
\DoxyCodeLine{66         ble.gap().onConnection(connectCallback);}
\DoxyCodeLine{67         ble.gap().onDisconnection(disconnectCallback);}
\DoxyCodeLine{68 }
\DoxyCodeLine{69         ble.gattServer().addService(uartService);}
\DoxyCodeLine{70         ble.gattServer().onDataWritten(writeCallback);}
\DoxyCodeLine{71         ble.gattServer().onDataSent(sentCallback);}
\DoxyCodeLine{72 }
\DoxyCodeLine{73         \textcolor{comment}{// Setup advertising}}
\DoxyCodeLine{74         ble.gap().accumulateAdvertisingPayload(GapAdvertisingData::COMPLETE\_LIST\_128BIT\_SERVICE\_IDS,}
\DoxyCodeLine{75                                               uart\_base\_uuid\_rev, \textcolor{keyword}{sizeof}(uart\_base\_uuid));}
\DoxyCodeLine{76 }
\DoxyCodeLine{77     \}}
\DoxyCodeLine{78 }
\DoxyCodeLine{79     \textcolor{keywordtype}{bool} connect() \{}
\DoxyCodeLine{80         mBuffRX.clear();}
\DoxyCodeLine{81         \textcolor{keywordflow}{return} mConn = \textcolor{keyword}{true};}
\DoxyCodeLine{82     \}}
\DoxyCodeLine{83 }
\DoxyCodeLine{84     \textcolor{keywordtype}{void} disconnect() \{}
\DoxyCodeLine{85         mConn = \textcolor{keyword}{false};}
\DoxyCodeLine{86     \}}
\DoxyCodeLine{87 }
\DoxyCodeLine{88     \textcolor{keywordtype}{bool} connected() \{}
\DoxyCodeLine{89         \textcolor{keywordflow}{return} mConn;}
\DoxyCodeLine{90     \}}
\DoxyCodeLine{91 }
\DoxyCodeLine{92     \textcolor{keywordtype}{size\_t} read(\textcolor{keywordtype}{void}* buf, \textcolor{keywordtype}{size\_t} len) \{}
\DoxyCodeLine{93         millis\_time\_t start = BlynkMillis();}
\DoxyCodeLine{94         \textcolor{keywordflow}{while} (BlynkMillis() -\/ start < BLYNK\_TIMEOUT\_MS) \{}
\DoxyCodeLine{95             \textcolor{keywordflow}{if} (available() < len) \{}
\DoxyCodeLine{96                 ble.waitForEvent();}
\DoxyCodeLine{97             \} \textcolor{keywordflow}{else} \{}
\DoxyCodeLine{98                 \textcolor{keywordflow}{break};}
\DoxyCodeLine{99             \}}
\DoxyCodeLine{100         \}}
\DoxyCodeLine{101         noInterrupts();}
\DoxyCodeLine{102         \textcolor{keywordtype}{size\_t} res = mBuffRX.get((uint8\_t*)buf, len);}
\DoxyCodeLine{103         interrupts();}
\DoxyCodeLine{104         \textcolor{keywordflow}{return} res;}
\DoxyCodeLine{105     \}}
\DoxyCodeLine{106 }
\DoxyCodeLine{107     \textcolor{keywordtype}{size\_t} write(\textcolor{keyword}{const} \textcolor{keywordtype}{void}* buf, \textcolor{keywordtype}{size\_t} len) \{}
\DoxyCodeLine{108         ble.updateCharacteristicValue(rxCharacteristic.getValueAttribute().getHandle(), (uint8\_t*)buf, len);}
\DoxyCodeLine{109         \textcolor{keywordflow}{return} len;}
\DoxyCodeLine{110     \}}
\DoxyCodeLine{111 }
\DoxyCodeLine{112     \textcolor{keywordtype}{size\_t} available() \{}
\DoxyCodeLine{113         noInterrupts();}
\DoxyCodeLine{114         \textcolor{keywordtype}{size\_t} rxSize = mBuffRX.size();}
\DoxyCodeLine{115         interrupts();}
\DoxyCodeLine{116         \textcolor{keywordflow}{return} rxSize;}
\DoxyCodeLine{117     \}}
\DoxyCodeLine{118 }
\DoxyCodeLine{119 \textcolor{keyword}{private}:}
\DoxyCodeLine{120     \textcolor{keyword}{static} \mbox{\hyperlink{class_blynk_transport_red_bear_lab___b_l_e___nano}{BlynkTransportRedBearLab\_BLE\_Nano}}* instance;}
\DoxyCodeLine{121 }
\DoxyCodeLine{122     \textcolor{keyword}{static}}
\DoxyCodeLine{123     \textcolor{keywordtype}{void} writeCallback(\textcolor{keyword}{const} GattWriteCallbackParams *params)}
\DoxyCodeLine{124     \{}
\DoxyCodeLine{125         \textcolor{keywordflow}{if} (!instance)}
\DoxyCodeLine{126             \textcolor{keywordflow}{return};}
\DoxyCodeLine{127       noInterrupts();}
\DoxyCodeLine{128       \textcolor{comment}{//BLYNK\_DBG\_DUMP("{}>> "{}, params-\/>data, params-\/>len);}}
\DoxyCodeLine{129       instance-\/>mBuffRX.put(params-\/>data, params-\/>len);}
\DoxyCodeLine{130       interrupts();}
\DoxyCodeLine{131     \}}
\DoxyCodeLine{132 }
\DoxyCodeLine{133     \textcolor{keyword}{static}}
\DoxyCodeLine{134     \textcolor{keywordtype}{void} sentCallback(\textcolor{keywordtype}{unsigned} count)}
\DoxyCodeLine{135     \{}
\DoxyCodeLine{136       \textcolor{comment}{//Serial.print("{}SENT: "{});}}
\DoxyCodeLine{137       \textcolor{comment}{//Serial.println(count);}}
\DoxyCodeLine{138     \}}
\DoxyCodeLine{139 }
\DoxyCodeLine{140     \textcolor{keyword}{static}}
\DoxyCodeLine{141     \textcolor{keywordtype}{void} connectCallback(\textcolor{keyword}{const} Gap::ConnectionCallbackParams\_t *params);}
\DoxyCodeLine{142 }
\DoxyCodeLine{143     \textcolor{keyword}{static}}
\DoxyCodeLine{144     \textcolor{keywordtype}{void} disconnectCallback(\textcolor{keyword}{const} Gap::DisconnectionCallbackParams\_t *params);}
\DoxyCodeLine{145 }
\DoxyCodeLine{146 \textcolor{keyword}{private}:}
\DoxyCodeLine{147     \textcolor{keywordtype}{bool} mConn;}
\DoxyCodeLine{148 }
\DoxyCodeLine{149     \mbox{\hyperlink{class_blynk_fifo}{BlynkFifo<uint8\_t, BLYNK\_MAX\_READBYTES*2>}} mBuffRX;}
\DoxyCodeLine{150 \};}
\DoxyCodeLine{151 }
\DoxyCodeLine{152 \textcolor{keyword}{class }\mbox{\hyperlink{class_blynk_red_bear_lab___b_l_e___nano}{BlynkRedBearLab\_BLE\_Nano}}}
\DoxyCodeLine{153     : \textcolor{keyword}{public} \mbox{\hyperlink{class_blynk_protocol}{BlynkProtocol}}<BlynkTransportRedBearLab\_BLE\_Nano>}
\DoxyCodeLine{154 \{}
\DoxyCodeLine{155     \textcolor{keyword}{typedef} \mbox{\hyperlink{class_blynk_protocol}{BlynkProtocol<BlynkTransportRedBearLab\_BLE\_Nano>}} \mbox{\hyperlink{class_blynk_protocol}{Base}};}
\DoxyCodeLine{156 \textcolor{keyword}{public}:}
\DoxyCodeLine{157     \mbox{\hyperlink{class_blynk_red_bear_lab___b_l_e___nano}{BlynkRedBearLab\_BLE\_Nano}}(\mbox{\hyperlink{class_blynk_transport_red_bear_lab___b_l_e___nano}{BlynkTransportRedBearLab\_BLE\_Nano}}\& transp)}
\DoxyCodeLine{158         : \mbox{\hyperlink{class_blynk_protocol}{Base}}(transp)}
\DoxyCodeLine{159     \{\}}
\DoxyCodeLine{160 }
\DoxyCodeLine{161     \textcolor{keywordtype}{void} begin(\textcolor{keyword}{const} \textcolor{keywordtype}{char}* auth)}
\DoxyCodeLine{162     \{}
\DoxyCodeLine{163         Base::begin(auth);}
\DoxyCodeLine{164         state = DISCONNECTED;}
\DoxyCodeLine{165         conn.begin();}
\DoxyCodeLine{166     \}}
\DoxyCodeLine{167 \};}
\DoxyCodeLine{168 }
\DoxyCodeLine{169 \mbox{\hyperlink{class_blynk_transport_red_bear_lab___b_l_e___nano}{BlynkTransportRedBearLab\_BLE\_Nano}}* BlynkTransportRedBearLab\_BLE\_Nano::instance = NULL;}
\DoxyCodeLine{170 }
\DoxyCodeLine{171 \textcolor{keyword}{static} \mbox{\hyperlink{class_blynk_transport_red_bear_lab___b_l_e___nano}{BlynkTransportRedBearLab\_BLE\_Nano}} \_blynkTransport;}
\DoxyCodeLine{172 \mbox{\hyperlink{class_blynk_red_bear_lab___b_l_e___nano}{BlynkRedBearLab\_BLE\_Nano}} Blynk(\_blynkTransport);}
\DoxyCodeLine{173 }
\DoxyCodeLine{174 \textcolor{keywordtype}{void} BlynkTransportRedBearLab\_BLE\_Nano::connectCallback(\textcolor{keyword}{const} Gap::ConnectionCallbackParams\_t *params)}
\DoxyCodeLine{175 \{}
\DoxyCodeLine{176   BLYNK\_LOG1(\textcolor{stringliteral}{"{}Device connected"{}});}
\DoxyCodeLine{177   Blynk.startSession();}
\DoxyCodeLine{178 \}}
\DoxyCodeLine{179 }
\DoxyCodeLine{180 \textcolor{keywordtype}{void} BlynkTransportRedBearLab\_BLE\_Nano::disconnectCallback(\textcolor{keyword}{const} Gap::DisconnectionCallbackParams\_t *params)}
\DoxyCodeLine{181 \{}
\DoxyCodeLine{182   BLYNK\_LOG1(\textcolor{stringliteral}{"{}Device disconnected"{}});}
\DoxyCodeLine{183   \textcolor{comment}{//\_\_disable\_irq();}}
\DoxyCodeLine{184   Blynk.disconnect();}
\DoxyCodeLine{185   \textcolor{comment}{//\_\_enable\_irq();}}
\DoxyCodeLine{186   ble.startAdvertising();}
\DoxyCodeLine{187 \}}
\DoxyCodeLine{188 }
\DoxyCodeLine{189 \textcolor{preprocessor}{\#include <\mbox{\hyperlink{_blynk_widgets_8h}{BlynkWidgets.h}}>}}
\DoxyCodeLine{190 }
\DoxyCodeLine{191 \textcolor{preprocessor}{\#endif}}

\end{DoxyCode}
